<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PID Odjezdy â€” PraÅ¾skÃ¡ integrovanÃ¡ doprava</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#0a0c10; --bg2:#111318; --bg3:#1a1d24; --border:#252932;
  --text:#e8eaf0; --text2:#8a8f9e; --text3:#545966;
  --accent:#f5c842; --accent2:#ff6b35; --accent3:#4ea8ff;
  --green:#44d986; --red:#ff4f4f; --orange:#ff9f40;
  --ma:#00a562; --mb:#f5c842; --mc:#c8102e;
  --R:10px; --M:'Space Mono',monospace; --S:'DM Sans',sans-serif; --T:.18s ease;
}
[data-theme="light"]{--bg:#f0ede6;--bg2:#fff;--bg3:#e8e4db;--border:#d5cfc4;--text:#1a1a1a;--text2:#5a5a6a;--text3:#9a9aaa;--accent:#c89a00;--accent2:#d44010;--accent3:#0055cc;}
[data-theme="tram"]{--bg:#0c1a0e;--bg2:#112014;--bg3:#162b1a;--border:#1d3422;--text:#d0f5d8;--text2:#60b070;--text3:#386440;--accent:#44d986;--accent2:#90ff60;--accent3:#60ffd0;}
[data-theme="metro"]{--bg:#04060f;--bg2:#070b1c;--bg3:#0c1230;--border:#13193e;--text:#bcd4ff;--text2:#5870a4;--text3:#303c60;--accent:#4ea8ff;--accent2:#9060ff;--accent3:#ff50a0;}
[data-theme="terminal"]{--bg:#000;--bg2:#040404;--bg3:#080808;--border:#141414;--text:#00ff41;--text2:#007718;--text3:#003c0c;--accent:#00ff41;--accent2:#00cc33;--accent3:#009926;}

*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--S);min-height:100vh;transition:background var(--T),color var(--T);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.layout{display:grid;grid-template-columns:268px 1fr;grid-template-rows:58px 1fr;min-height:100vh;}

/* â”€â”€ HEADER â”€â”€ */
header{
  grid-column:1/-1;
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 18px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-badge{width:32px;height:32px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;font:700 12px/1 var(--M);color:#000;flex-shrink:0;}
.logo-name{font:700 13px/1 var(--M);}
.logo-sub{font:400 9px/1 var(--M);color:var(--text3);letter-spacing:.07em;text-transform:uppercase;margin-top:3px;}
.hdr-r{display:flex;align-items:center;gap:9px;}
.live{display:flex;align-items:center;gap:5px;background:rgba(68,217,134,.1);border:1px solid rgba(68,217,134,.22);border-radius:20px;padding:3px 9px;font:400 10px/1 var(--M);color:var(--green);}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:blink 1.4s ease infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
#clock{font:400 13px/1 var(--M);color:var(--text2);}
.themes{display:flex;gap:3px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:3px;}
.tb{width:19px;height:19px;border-radius:4px;border:2px solid transparent;cursor:pointer;transition:transform .13s,border-color .13s;position:relative;}
.tb:hover{transform:scale(1.3);}
.tb.on{border-color:var(--accent);}
.tb[data-t="dark"]{background:#111318;}
.tb[data-t="light"]{background:#f0ede6;}
.tb[data-t="tram"]{background:#112014;}
.tb[data-t="metro"]{background:#070b1c;}
.tb[data-t="terminal"]{background:#000;}
.tbt{position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font:400 9px/1 var(--M);white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .12s;}
.tb:hover .tbt{opacity:1;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;gap:6px;}
.s-sec{padding:0 13px;margin-bottom:4px;}
.s-lbl{font:400 9px/1 var(--M);letter-spacing:.1em;text-transform:uppercase;color:var(--text3);padding:0 8px;margin-bottom:6px;display:block;}
.nav-btn{width:100%;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;border:none;background:transparent;color:var(--text2);cursor:pointer;font:500 13px/1 var(--S);transition:background var(--T),color var(--T);text-align:left;margin-bottom:1px;}
.nav-btn:hover{background:var(--bg3);color:var(--text);}
.nav-btn.active{background:rgba(245,200,66,.1);color:var(--accent);}
.ni{font-size:14px;width:17px;text-align:center;}

/* API KEY AREA */
.api-area{padding:0 13px;margin-bottom:4px;}
.api-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text);font:400 10px/1 var(--M);outline:none;transition:border-color var(--T);}
.api-input:focus{border-color:var(--accent);}
.api-input::placeholder{color:var(--text3);}
.api-btn{width:100%;margin-top:4px;padding:6px;background:var(--accent);color:#000;border:none;border-radius:6px;font:700 10px/1 var(--M);cursor:pointer;letter-spacing:.04em;transition:opacity var(--T);}
.api-btn:hover{opacity:.8;}
.api-st{font:400 9px/1 var(--M);margin-top:4px;padding:0 2px;}
.api-st.ok{color:var(--green);}
.api-st.err{color:var(--red);}

/* SAVED STOPS */
.saved-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background var(--T);margin-bottom:1px;}
.saved-item:hover{background:var(--bg3);}
.saved-item.cur{background:rgba(245,200,66,.08);}
.si-name{font:500 12px/1.2 var(--S);color:var(--text);}
.si-id{font:400 9px/1 var(--M);color:var(--text3);margin-top:2px;}
.si-rm{background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:2px 3px;border-radius:3px;transition:color var(--T);}
.si-rm:hover{color:var(--red);}
.s-empty{padding:5px 10px;font:italic 11px/1 var(--S);color:var(--text3);}

/* â”€â”€ MAIN â”€â”€ */
.main{overflow-y:auto;padding:20px;background:var(--bg);}
.page{display:none;animation:fadeIn .2s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH BAR */
.sbar{display:flex;gap:8px;margin-bottom:7px;}
.sinput{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);padding:10px 14px;color:var(--text);font:400 14px/1 var(--S);outline:none;transition:border-color var(--T);}
.sinput:focus{border-color:var(--accent);}
.sinput::placeholder{color:var(--text3);}
.sbtn{padding:10px 16px;background:var(--accent);color:#000;border:none;border-radius:var(--R);font:700 12px/1 var(--M);cursor:pointer;transition:opacity var(--T),transform .1s;white-space:nowrap;letter-spacing:.03em;}
.sbtn:hover{opacity:.82;}
.sbtn:active{transform:scale(.96);}

/* SEARCH RESULTS DROPDOWN */
.sresults{background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);overflow:hidden;margin-bottom:13px;display:none;max-height:260px;overflow-y:auto;}
.sri{padding:9px 14px;cursor:pointer;transition:background var(--T);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.sri:last-child{border-bottom:none;}
.sri:hover{background:var(--bg3);}
.sri-name{font:500 13px/1 var(--S);}
.sri-meta{font:400 10px/1 var(--M);color:var(--text3);margin-top:3px;}

/* ERROR BOX */
.errbox{background:rgba(255,79,79,.1);border:1px solid rgba(255,79,79,.28);border-radius:8px;padding:10px 13px;font:400 12px/1.4 var(--S);color:var(--red);margin-bottom:13px;display:none;}

/* BOARD */
.board-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:13px;}
.board-title{font:700 19px/1.2 var(--M);letter-spacing:-.02em;}
.board-sub{font:400 10px/1 var(--M);color:var(--text3);margin-top:4px;}
.board-acts{display:flex;gap:6px;}
.ic-btn{width:32px;height:32px;background:var(--bg2);border:1px solid var(--border);border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text2);transition:all var(--T);}
.ic-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--accent);}

/* REFRESH BAR */
.rbar{background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);padding:8px 12px;margin-bottom:13px;display:flex;align-items:center;gap:10px;}
.rl{font:400 10px/1 var(--M);color:var(--text2);white-space:nowrap;}
.rprog{flex:1;height:2px;background:var(--border);border-radius:1px;overflow:hidden;}
.rfill{height:100%;background:var(--accent);border-radius:1px;transition:width 1s linear;}

/* FILTER TABS */
.ftabs{display:flex;gap:5px;margin-bottom:16px;flex-wrap:wrap;}
.ftab{padding:4px 11px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font:400 10px/1 var(--M);cursor:pointer;transition:all var(--T);}
.ftab:hover{border-color:var(--accent);color:var(--text);}
.ftab.on{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700;}

/* DEPARTURE TABLE */
.dtable{width:100%;border-collapse:collapse;font-size:13px;}
.dtable thead tr{border-bottom:1px solid var(--border);}
.dtable th{text-align:left;padding:6px 10px;font:400 9px/1 var(--M);letter-spacing:.1em;text-transform:uppercase;color:var(--text3);}
.drow{border-bottom:1px solid var(--border);transition:background var(--T);animation:rowIn .28s ease forwards;opacity:0;}
.drow:hover{background:var(--bg2);}
@keyframes rowIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.drow td{padding:9px 10px;vertical-align:middle;}

/* ROUTE BADGE */
.rb{display:inline-flex;align-items:center;justify-content:center;min-width:36px;padding:3px 6px;border-radius:5px;font:700 11px/1 var(--M);}
.rb-bus{background:rgba(78,168,255,.14);color:var(--accent3);}
.rb-tram{background:rgba(255,107,53,.14);color:var(--accent2);}
.rb-ma{background:rgba(0,165,98,.18);color:var(--ma);}
.rb-mb{background:rgba(245,200,66,.18);color:var(--mb);}
.rb-mc{background:rgba(200,16,46,.18);color:var(--mc);}
.rb-night{background:rgba(138,143,158,.14);color:var(--text2);}
.rb-train{background:rgba(180,100,255,.14);color:#b464ff;}
.rb-ferry{background:rgba(0,200,255,.14);color:#00c8ff;}

/* MINUTES PILL */
.mins{display:inline-block;font:700 11px/1 var(--M);padding:2px 6px;border-radius:4px;}
.mins.now{background:var(--accent);color:#000;animation:fla 1s ease infinite;}
.mins.soon{background:rgba(255,79,79,.14);color:var(--red);}
.mins.near{background:rgba(255,159,64,.14);color:var(--orange);}
.mins.ok{background:rgba(68,217,134,.11);color:var(--green);}
@keyframes fla{0%,100%{opacity:1}50%{opacity:.5}}

/* DELAY */
.dl{font:400 10px/1 var(--M);}
.dl.late{color:var(--red);}
.dl.early{color:var(--accent3);}
.dl.ok{color:var(--green);}

/* STATE BOX */
.sbox{padding:52px 20px;text-align:center;color:var(--text3);}
.sbox-icon{font-size:42px;margin-bottom:13px;opacity:.45;}
.sbox-title{font:700 16px/1 var(--M);color:var(--text2);margin-bottom:7px;}
.sbox-desc{font:400 12px/1.6 var(--S);max-width:360px;margin:0 auto;}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .75s linear infinite;margin:0 auto 13px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* VEHICLES */
.vgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:16px;}
.vc{background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);padding:14px;transition:border-color var(--T),transform .14s;animation:rowIn .28s ease forwards;opacity:0;}
.vc:hover{border-color:var(--accent);transform:translateY(-2px);}
.vc-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.vc-hs{font:700 13px/1.2 var(--S);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px;}
.vc-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 1.4s ease infinite;margin-top:5px;}
.vm{display:grid;grid-template-columns:1fr 1fr;gap:6px;font:400 9px/1 var(--M);}
.vmi{background:var(--bg3);border-radius:5px;padding:5px 6px;}
.vml{color:var(--text3);margin-bottom:2px;}
.vmv{color:var(--text);font-weight:700;}
.vmv.late{color:var(--red);}
.vmv.ok{color:var(--green);}
.vmv.early{color:var(--accent3);}

/* ABOUT / SETTINGS */
.pg-title{font:700 18px/1 var(--M);margin-bottom:4px;letter-spacing:-.02em;}
.pg-sub{font:400 12px/1 var(--S);color:var(--text3);margin-bottom:20px;}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);padding:20px;margin-bottom:14px;}
.card-title{font:400 10px/1 var(--M);letter-spacing:.08em;text-transform:uppercase;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
.card-title::after{content:'';flex:1;height:1px;background:var(--border);}

.feat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.feat{display:flex;align-items:flex-start;gap:8px;padding:8px;background:var(--bg3);border-radius:6px;}
.feat-ico{font-size:16px;margin-top:1px;}
.feat-t h4{font:700 11px/1 var(--S);margin-bottom:2px;}
.feat-t p{font:400 10px/1.35 var(--S);color:var(--text2);}

.cl-row{display:flex;gap:13px;padding:11px 0;border-bottom:1px solid var(--border);}
.cl-row:last-child{border-bottom:none;}
.cl-v{font:700 10px/1 var(--M);color:var(--accent);white-space:nowrap;min-width:40px;}
.cl-d{font:400 9px/1 var(--M);color:var(--text3);margin-top:2px;}
.cl-e h4{font:700 11px/1 var(--S);margin-bottom:3px;}
.cl-e ul{padding-left:13px;}
.cl-e li{font:400 10px/1.5 var(--S);color:var(--text2);margin-bottom:1px;}
.tag{display:inline-block;padding:1px 5px;border-radius:3px;font:700 8px/1 var(--M);margin-right:3px;letter-spacing:.04em;}
.tg-new{background:rgba(68,217,134,.14);color:var(--green);}
.tg-fix{background:rgba(255,79,79,.14);color:var(--red);}
.tg-imp{background:rgba(78,168,255,.14);color:var(--accent3);}

.set-row{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:6px;margin-bottom:7px;flex-wrap:wrap;gap:7px;}
.set-row:last-child{margin-bottom:0;}
.sl h4{font:500 12px/1 var(--S);}
.sl p{font:400 9px/1 var(--S);color:var(--text3);margin-top:2px;}
.tog{width:36px;height:18px;background:var(--border);border-radius:9px;position:relative;cursor:pointer;transition:background var(--T);flex-shrink:0;}
.tog.on{background:var(--accent);}
.tog::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left var(--T);}
.tog.on::after{left:20px;}
.ss{background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:4px 6px;color:var(--text);font:400 10px/1 var(--M);outline:none;cursor:pointer;}

.about-hero{background:var(--bg2);border:1px solid var(--border);border-radius:var(--R);padding:26px;margin-bottom:14px;position:relative;overflow:hidden;}
.about-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,200,66,.06) 0%,transparent 70%);pointer-events:none;}
.ah-title{font:700 24px/1.1 var(--M);letter-spacing:-.03em;margin-bottom:7px;}
.ah-title span{color:var(--accent);}
.ah-desc{font:400 13px/1.7 var(--S);color:var(--text2);}
.ah-links{margin-top:16px;display:flex;gap:6px;flex-wrap:wrap;}
.alink{display:inline-flex;align-items:center;gap:5px;padding:6px 11px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;font:400 10px/1 var(--M);color:var(--text2);text-decoration:none;transition:border-color var(--T),color var(--T);}
.alink:hover{border-color:var(--accent);color:var(--accent);}

.author-badge{display:inline-flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-top:14px;}
.author-av{width:32px;height:32px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font:700 13px/1 var(--M);color:#000;flex-shrink:0;}
.author-name{font:700 12px/1 var(--S);margin-bottom:2px;}
.author-gh{font:400 10px/1 var(--M);color:var(--text3);}
.author-gh a{color:var(--accent3);text-decoration:none;}
.author-gh a:hover{text-decoration:underline;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--text3);}

@media(max-width:700px){
  .layout{grid-template-columns:1fr;grid-template-rows:58px auto 1fr;}
  .sidebar{flex-direction:row;border-right:none;border-bottom:1px solid var(--border);padding:8px 0;overflow-x:auto;gap:0;}
  .s-sec{margin-bottom:0;}
  .s-lbl,.api-area,.saved-sect{display:none;}
  .nav-btn{width:auto;white-space:nowrap;}
  .feat-grid{grid-template-columns:1fr;}
  #clock{display:none;}
}
</style>
</head>
<body data-theme="dark">
<div class="layout">

<!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">
    <div class="logo-badge">PID</div>
    <div>
      <div class="logo-name">OdjezdovÃ¡ tabule</div>
      <div class="logo-sub">CIS Â· Golemio API v2</div>
    </div>
  </div>
  <div class="hdr-r">
    <div class="live"><div class="live-dot"></div>Å½IVÄš</div>
    <div id="clock">--:--:--</div>
    <div class="themes">
      <button class="tb on" data-t="dark"  onclick="setTheme('dark')"><span class="tbt">NoÄnÃ­</span></button>
      <button class="tb"    data-t="light" onclick="setTheme('light')"><span class="tbt">DennÃ­</span></button>
      <button class="tb"    data-t="tram"  onclick="setTheme('tram')"><span class="tbt">Tramvaj</span></button>
      <button class="tb"    data-t="metro" onclick="setTheme('metro')"><span class="tbt">Metro</span></button>
      <button class="tb"    data-t="terminal" onclick="setTheme('terminal')"><span class="tbt">TerminÃ¡l</span></button>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar">
  <div class="s-sec">
    <span class="s-lbl">Navigace</span>
    <button class="nav-btn active" onclick="nav('departures',this)"><span class="ni">ğŸš</span> Odjezdy</button>
    <button class="nav-btn" onclick="nav('vehicles',this)"><span class="ni">ğŸšŒ</span> Vozidla</button>
    <button class="nav-btn" onclick="nav('settings',this)"><span class="ni">âš™ï¸</span> NastavenÃ­</button>
    <button class="nav-btn" onclick="nav('about',this)"><span class="ni">â„¹ï¸</span> O aplikaci</button>
  </div>

  <div class="api-area">
    <span class="s-lbl" style="display:block">Golemio API klÃ­Ä</span>
    <input class="api-input" type="password" id="apiKey" placeholder="VloÅ¾te klÃ­Äâ€¦" autocomplete="off">
    <button class="api-btn" onclick="saveKey()">ğŸ’¾ UloÅ¾it klÃ­Ä</button>
    <div class="api-st" id="keySt"></div>
    <div style="margin-top:6px;font:400 9px/1.5 var(--M);color:var(--text3)">KlÃ­Ä zdarma:<br><a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--accent3);text-decoration:none">api.golemio.cz â†’</a></div>
  </div>

  <div class="s-sec saved-sect">
    <span class="s-lbl">OblÃ­benÃ© zastÃ¡vky</span>
    <div id="savedList"></div>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">

<!-- â”€â”€â”€ ODJEZDY â”€â”€â”€ -->
<div class="page active" id="page-departures">
  <div class="sbar">
    <input class="sinput" id="q" type="text"
      placeholder="Hledat zastÃ¡vku (napÅ™. AndÄ›l, NÃ¡mÄ›stÃ­ MÃ­ru, HlavnÃ­ nÃ¡draÅ¾Ã­â€¦)"
      oninput="debSearch()" onkeydown="if(event.key==='Enter')doSearch()">
    <button class="sbtn" onclick="doSearch()">ğŸ” Hledat</button>
  </div>
  <div class="sresults" id="sr"></div>
  <div class="errbox" id="edep"></div>
  <div id="board">
    <div class="sbox">
      <div class="sbox-icon">ğŸš</div>
      <div class="sbox-title">Vyhledejte zastÃ¡vku</div>
      <div class="sbox-desc">NapiÅ¡te nÃ¡zev zastÃ¡vky a stisknÄ›te Enter. API klÃ­Ä je nutnÃ½ â€” zadejte ho vlevo.</div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ VOZIDLA â”€â”€â”€ -->
<div class="page" id="page-vehicles">
  <div class="pg-title">ğŸšŒ Vozidla v provozu</div>
  <div class="pg-sub">Å½ivÃ© polohy vozidel PID â€” vyÅ¾aduje API klÃ­Ä</div>
  <div class="sbar">
    <input class="sinput" id="vq" type="text" placeholder="Filtrovat dle linky (napÅ™. 22, A, 207)â€¦" oninput="filterVeh()">
    <button class="sbtn" onclick="loadVeh()">âŸ³ NaÄÃ­st</button>
  </div>
  <div class="errbox" id="eveh"></div>
  <div id="vboard">
    <div class="sbox"><div class="sbox-icon">ğŸ—ºï¸</div><div class="sbox-title">KliknÄ›te na NaÄÃ­st</div><div class="sbox-desc">ZobrazÃ­ aktuÃ¡lnÃ­ polohy a zpoÅ¾dÄ›nÃ­ vozidel.</div></div>
  </div>
</div>

<!-- â”€â”€â”€ NASTAVENÃ â”€â”€â”€ -->
<div class="page" id="page-settings">
  <div class="pg-title">âš™ï¸ NastavenÃ­</div>
  <div class="pg-sub">PÅ™izpÅ¯sobte si aplikaci</div>
  <div class="card">
    <div class="card-title">Odjezdy</div>
    <div class="set-row"><div class="sl"><h4>AutomatickÃ© obnovenÃ­</h4><p>Interval v sekundÃ¡ch</p></div>
      <select class="ss" id="cfgR" onchange="sc('refresh',this.value)">
        <option value="20">20s</option><option value="30" selected>30s</option>
        <option value="45">45s</option><option value="60">60s</option><option value="0">Vypnout</option>
      </select></div>
    <div class="set-row"><div class="sl"><h4>PoÄet odjezdÅ¯</h4><p>Max. poÄet najednou</p></div>
      <select class="ss" id="cfgL" onchange="sc('lim',this.value)">
        <option value="5">5</option><option value="10" selected>10</option>
        <option value="15">15</option><option value="20">20</option>
      </select></div>
    <div class="set-row"><div class="sl"><h4>PÅ™eskoÄit "u zastÃ¡vky"</h4><p>Nezobrazit odj. ze zastÃ¡vky</p></div>
      <div class="tog on" id="tSkip" onclick="st('skip',this)"></div></div>
    <div class="set-row"><div class="sl"><h4>Klimatizace â„ï¸</h4><p>Ikona u vybavenÃ½ch vozidel</p></div>
      <div class="tog on" id="tAC" onclick="st('ac',this)"></div></div>
    <div class="set-row"><div class="sl"><h4>ZobrazenÃ­ Äasu</h4><p>Minuty nebo Äas odjezdu</p></div>
      <select class="ss" id="cfgT" onchange="sc('tm',this.value)">
        <option value="minutes" selected>Minuty</option><option value="time">ÄŒas odjezdu</option><option value="both">ObojÃ­</option>
      </select></div>
  </div>
  <div class="card">
    <div class="card-title">TÃ©ma</div>
    <div class="set-row">
      <div class="sl"><h4>BarevnÃ© schÃ©ma</h4></div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button onclick="setTheme('dark')" class="sbtn" style="padding:5px 9px;font-size:10px">ğŸŒ™ NoÄnÃ­</button>
        <button onclick="setTheme('light')" class="sbtn" style="padding:5px 9px;font-size:10px;background:var(--bg3);color:var(--text)">â˜€ï¸ DennÃ­</button>
        <button onclick="setTheme('tram')" class="sbtn" style="padding:5px 9px;font-size:10px;background:rgba(68,217,134,.18);color:var(--green)">ğŸšƒ Tramvaj</button>
        <button onclick="setTheme('metro')" class="sbtn" style="padding:5px 9px;font-size:10px;background:rgba(78,168,255,.18);color:var(--accent3)">ğŸš‡ Metro</button>
        <button onclick="setTheme('terminal')" class="sbtn" style="padding:5px 9px;font-size:10px;background:#000;color:#00ff41">ğŸ’» TerminÃ¡l</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Data</div>
    <div class="set-row"><div class="sl"><h4>Smazat oblÃ­benÃ©</h4><p>OdstranÃ­ vÅ¡echny uloÅ¾enÃ© zastÃ¡vky</p></div>
      <button onclick="clearSaved()" style="padding:4px 9px;font:700 10px/1 var(--M);background:rgba(255,79,79,.14);color:var(--red);border:1px solid rgba(255,79,79,.28);border-radius:5px;cursor:pointer">Smazat</button></div>
    <div class="set-row"><div class="sl"><h4>Smazat API klÃ­Ä</h4><p>OdstranÃ­ z pamÄ›ti prohlÃ­Å¾eÄe</p></div>
      <button onclick="clearKey()" style="padding:4px 9px;font:700 10px/1 var(--M);background:rgba(255,79,79,.14);color:var(--red);border:1px solid rgba(255,79,79,.28);border-radius:5px;cursor:pointer">Smazat</button></div>
  </div>
</div>

<!-- â”€â”€â”€ O APLIKACI â”€â”€â”€ -->
<div class="page" id="page-about" style="max-width:680px">
  <div class="about-hero">
    <div class="ah-title">PID <span>OdjezdovÃ¡</span><br>Tabule</div>
    <div class="ah-desc">WebovÃ¡ aplikace pro Å¾ivÃ© odjezdy PraÅ¾skÃ© integrovanÃ© dopravy pomocÃ­ <strong>Golemio API v2</strong> a systÃ©mu <strong>CIS</strong> (CelostÃ¡tnÃ­ informaÄnÃ­ systÃ©m o jÃ­zdnÃ­ch Å™Ã¡dech).</div>
    <div class="ah-links">
      <a class="alink" href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank">ğŸ”‘ ZÃ­skat API klÃ­Ä</a>
      <a class="alink" href="https://api.golemio.cz/v2/pid/docs/openapi/" target="_blank">ğŸ“– API Dokumentace</a>
      <a class="alink" href="https://pid.cz/o-systemu/opendata/" target="_blank">ğŸ“Š Opendata PID</a>
    </div>
    <div class="author-badge">
      <div class="author-av">JR</div>
      <div>
        <div class="author-name">Jakub RÅ¯Å¾iÄka</div>
        <div class="author-gh">GitHub: <a href="https://github.com/thejakubruzicka" target="_blank">@thejakubruzicka</a></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Jak zaÄÃ­t</div>
    <div style="font:400 12px/1.9 var(--S);color:var(--text2)">
      <strong style="color:var(--text)">1.</strong> Zaregistrujte se na <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--accent3);text-decoration:none">api.golemio.cz</a> a zÃ­skejte bezplatnÃ½ API klÃ­Ä.<br>
      <strong style="color:var(--text)">2.</strong> VloÅ¾te klÃ­Ä do pole v levÃ©m panelu a kliknÄ›te <em>UloÅ¾it klÃ­Ä</em>.<br>
      <strong style="color:var(--text)">3.</strong> PÅ™ejdÄ›te na <em>Odjezdy</em> a hledejte zastÃ¡vku (min. 2 znaky).<br>
      <strong style="color:var(--text)">4.</strong> UloÅ¾te oblÃ­benÃ© zastÃ¡vky kliknutÃ­m na â­ u tabule.<br>
      <strong style="color:var(--text)">5.</strong> PÅ™izpÅ¯sobte aplikaci v sekci <em>NastavenÃ­</em>.
    </div>
  </div>

  <div class="card">
    <div class="card-title">Funkce</div>
    <div class="feat-grid">
      <div class="feat"><div class="feat-ico">ğŸš</div><div class="feat-t"><h4>Å½ivÃ© odjezdy</h4><p>Data z Golemio API s auto-obnovenÃ­m</p></div></div>
      <div class="feat"><div class="feat-ico">ğŸ”</div><div class="feat-t"><h4>HledÃ¡nÃ­ zastÃ¡vek</h4><p>FulltextovÃ© hledÃ¡nÃ­ pÅ™es GTFS data</p></div></div>
      <div class="feat"><div class="feat-ico">ğŸšŒ</div><div class="feat-t"><h4>PÅ™ehled vozidel</h4><p>Polohy a zpoÅ¾dÄ›nÃ­ v reÃ¡lnÃ©m Äase</p></div></div>
      <div class="feat"><div class="feat-ico">â­</div><div class="feat-t"><h4>OblÃ­benÃ© zastÃ¡vky</h4><p>RychlÃ½ pÅ™Ã­stup z postrannÃ­ho panelu</p></div></div>
      <div class="feat"><div class="feat-ico">ğŸ¨</div><div class="feat-t"><h4>5 barevnÃ½ch tÃ©mat</h4><p>NoÄnÃ­ Â· DennÃ­ Â· Tramvaj Â· Metro Â· TerminÃ¡l</p></div></div>
      <div class="feat"><div class="feat-ico">ğŸ”„</div><div class="feat-t"><h4>Auto-obnovenÃ­</h4><p>NastavitelnÃ½ interval 20â€“60 s</p></div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Changelog &amp; Aktualizace</div>
    <div class="cl-row">
      <div><div class="cl-v">v2.2</div><div class="cl-d">Feb 2026</div></div>
      <div class="cl-e"><h4><span class="tag tg-fix">OPRAVA</span>Opraveny vÅ¡echny API problÃ©my</h4>
        <ul>
          <li>SprÃ¡vnÃ½ endpoint hledÃ¡nÃ­: <code>/v2/gtfsstops?names=</code></li>
          <li>SprÃ¡vnÃ½ endpoint odjezdÅ¯: <code>/v2/pid/departureboards?ids=</code> (GTFS IDs, bez lomÃ­tka za URL)</li>
          <li>SprÃ¡vnÃ½ parametr <code>total=</code> mÃ­sto <code>limit=</code> u odjezdÅ¯</li>
          <li>Opraven endpoint vozidel: <code>/v2/pid/vehiclepositions</code></li>
          <li>PÅ™idÃ¡n autor projektu: Jakub RÅ¯Å¾iÄka</li>
        </ul>
      </div>
    </div>
    <div class="cl-row">
      <div><div class="cl-v">v2.0</div><div class="cl-d">Feb 2026</div></div>
      <div class="cl-e"><h4><span class="tag tg-new">NOVÃ‰</span>KompletnÃ­ pÅ™epracovÃ¡nÃ­ UI</h4>
        <ul>
          <li>5 barevnÃ½ch tÃ©mat, strÃ¡nka Vozidla, NastavenÃ­, O aplikaci</li>
          <li>Progress bar auto-obnovenÃ­, filtrace dle typu dopravy</li>
          <li>ZobrazenÃ­ zpoÅ¾dÄ›nÃ­, rychlosti a klimatizace</li>
        </ul>
      </div>
    </div>
    <div class="cl-row">
      <div><div class="cl-v">v1.0</div><div class="cl-d">Sep 2025</div></div>
      <div class="cl-e"><h4><span class="tag tg-new">NOVÃ‰</span>PrvnÃ­ vydÃ¡nÃ­</h4>
        <ul><li>ZÃ¡kladnÃ­ odjezdovÃ¡ tabule s podporou MHD, tramvajÃ­, metra a vlakÅ¯</li></ul>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">TechnickÃ© info</div>
    <div style="font:400 9px/1.9 var(--M);color:var(--text3)">
      Search:&nbsp;&nbsp;&nbsp;&nbsp; GET /v2/gtfsstops?names=&lt;q&gt;&amp;limit=10<br>
      Odjezdy:&nbsp;&nbsp; GET /v2/pid/departureboards?ids=&lt;gtfsId&gt;&amp;total=N&amp;minutesAfter=120<br>
      Vozidla:&nbsp;&nbsp; GET /v2/pid/vehiclepositions?limit=50<br>
      Auth:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; X-Access-Token header Â· Data Â© OperÃ¡tor ICT, a.s.
    </div>
  </div>
</div>

</main>
</div><!-- .layout -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'https://api.golemio.cz/v2';

let key   = localStorage.getItem('pid.key') || '';
let cfg   = JSON.parse(localStorage.getItem('pid.cfg') || '{}');
let saved = JSON.parse(localStorage.getItem('pid.saved') || '[]');
let curId = '', curName = '';
let timer = null, cd = 30;
let allVeh = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString('cs-CZ'), 1000);
  if (key) { document.getElementById('apiKey').value = key; setKeySt('ok','âœ“ KlÃ­Ä naÄten'); }
  applyCfg();
  renderSaved();
  const t = localStorage.getItem('pid.theme');
  if (t) setTheme(t);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTheme(t) {
  document.body.dataset.theme = t;
  document.querySelectorAll('.tb').forEach(b => b.classList.toggle('on', b.dataset.t === t));
  localStorage.setItem('pid.theme', t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(p, btn) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  if (btn) btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveKey() {
  const v = document.getElementById('apiKey').value.trim();
  if (!v) { setKeySt('err','âœ— PrÃ¡zdnÃ½ klÃ­Ä'); return; }
  key = v; localStorage.setItem('pid.key', key); setKeySt('ok','âœ“ UloÅ¾en');
}
function clearKey() {
  key = ''; localStorage.removeItem('pid.key');
  document.getElementById('apiKey').value = ''; setKeySt('ok','âœ“ SmazÃ¡n');
}
function setKeySt(cls, msg) {
  const el = document.getElementById('keySt');
  el.textContent = msg; el.className = 'api-st ' + cls;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STOP SEARCH
//  Endpoint: GET /v2/gtfsstops?names=<q>&limit=10
//  Returns features[].properties.stop_id  â†’ e.g. "U100Z1P"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dt = null;
function debSearch() { clearTimeout(_dt); _dt = setTimeout(doSearch, 420); }

async function doSearch() {
  const q = document.getElementById('q').value.trim();
  const sr = document.getElementById('sr');
  if (q.length < 2) { sr.style.display = 'none'; return; }
  if (!key) { showErr('edep','Zadejte API klÃ­Ä v postrannÃ­m panelu.'); return; }
  hideErr('edep');
  try {
    // NOTE: no trailing slash, names= not name=
    const data = await pFetch(`${API}/gtfsstops?names=${encodeURIComponent(q)}&limit=12`);
    const stops = (data.features || []);
    if (!stops.length) {
      sr.innerHTML = `<div class="sri"><span class="sri-name" style="color:var(--text3)">Å½Ã¡dnÃ© vÃ½sledky pro â€${e(q)}"</span></div>`;
    } else {
      // Deduplicate by stop_name to group platforms â€” user picks a name,
      // then we pass the stop_id (GTFS format like U100Z1P) to the departure board
      sr.innerHTML = stops.slice(0,10).map(s => {
        const p  = s.properties || {};
        const nm = p.stop_name  || '?';
        const id = p.stop_id    || '';           // e.g. "U100Z1P"
        const zn = p.zone_id    ? `Â· ZÃ³na ${p.zone_id}` : '';
        const rt = (p.route_type_name || '').toLowerCase();
        const ic = rt.includes('metro') ? 'ğŸš‡' : rt.includes('tram') ? 'ğŸšƒ' : rt.includes('ferry') ? 'â›´' : 'ğŸšŒ';
        return `<div class="sri" onclick="loadDep('${esc(id)}','${esc(nm)}')">
          <div>
            <div class="sri-name">${ic} ${nm}</div>
            <div class="sri-meta">${id} ${zn}</div>
          </div>
          <span style="color:var(--text3);font-size:12px">â€º</span>
        </div>`;
      }).join('');
    }
    sr.style.display = 'block';
  } catch(err) {
    showErr('edep','Chyba hledÃ¡nÃ­: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEPARTURE BOARD
//  Endpoint: GET /v2/pid/departureboards?ids=<stopId>&total=N&minutesAfter=120
//  âš ï¸  Parameter is "ids" (GTFS stop_id) and "total" (not "limit")
//  âš ï¸  No trailing slash after "departureboards"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDep(stopId, stopName) {
  curId = stopId; curName = stopName;
  document.getElementById('sr').style.display = 'none';
  document.getElementById('q').value = stopName;
  hideErr('edep');
  stopTimer();
  setBoard(`<div class="sbox"><div class="spinner"></div><div class="sbox-title">NaÄÃ­tÃ¡m odjezdyâ€¦</div></div>`);

  const total  = parseInt(gcfg('lim', 10));
  const skip   = gcfg('skip', true)  ? '&skip=atStop' : '';
  const ac     = gcfg('ac', true)    ? '&airCondition=true' : '';

  try {
    // Correct URL: no slash, ids= (GTFS stop_id), total= (not limit=)
    const url  = `${API}/pid/departureboards?ids=${encodeURIComponent(stopId)}&total=${total}&minutesAfter=120${skip}${ac}`;
    const data = await pFetch(url);
    renderBoard(data, stopId, stopName);
    startTimer(stopId, stopName);
  } catch(err) {
    showErr('edep', 'Chyba naÄÃ­tÃ¡nÃ­: ' + err.message);
    setBoard(`<div class="sbox"><div class="sbox-icon">âš ï¸</div><div class="sbox-title">Chyba</div><div class="sbox-desc">${e(err.message)}</div></div>`);
  }
}

function renderBoard(data, stopId, stopName) {
  const deps    = data.departures || [];
  const isSaved = saved.some(s => s.id === stopId);
  const tm      = gcfg('tm','minutes');

  setBoard(`
    <div class="board-hdr">
      <div>
        <div class="board-title">ğŸ“ ${e(stopName)}</div>
        <div class="board-sub">ID: ${stopId} Â· ${deps.length} odjezdÅ¯ Â· ${new Date().toLocaleTimeString('cs-CZ')}</div>
      </div>
      <div class="board-acts">
        <button class="ic-btn" id="starBtn" onclick="toggleSaved('${esc(stopId)}','${esc(stopName)}')"
                title="${isSaved?'Odebrat z oblÃ­benÃ½ch':'PÅ™idat do oblÃ­benÃ½ch'}">${isSaved?'â­':'â˜†'}</button>
        <button class="ic-btn" onclick="loadDep('${esc(stopId)}','${esc(stopName)}')" title="Obnovit">âŸ³</button>
      </div>
    </div>

    <div class="rbar">
      <span class="rl">âŸ³ Za <span id="rcd">${gcfg('refresh',30)}</span>s</span>
      <div class="rprog"><div class="rfill" id="rfill" style="width:100%"></div></div>
      <span class="rl" style="color:var(--text3)">${new Date().toLocaleTimeString('cs-CZ')}</span>
    </div>

    <div class="ftabs">
      <button class="ftab on" onclick="fDep('all',this)">ğŸ”¢ VÅ¡e (${deps.length})</button>
      ${buildTabs(deps)}
    </div>

    ${deps.length === 0
      ? `<div class="sbox"><div class="sbox-icon">ğŸ˜´</div><div class="sbox-title">Å½Ã¡dnÃ© odjezdy</div><div class="sbox-desc">V blÃ­zkÃ© dobÄ› nejsou plÃ¡novÃ¡ny Å¾Ã¡dnÃ© odjezdy.</div></div>`
      : `<table class="dtable">
          <thead><tr>
            <th>Linka</th><th>SmÄ›r</th><th>ÄŒas</th>
            ${tm !== 'time' ? '<th>Za</th>' : ''}
            <th>ZpoÅ¾dÄ›nÃ­</th><th>StÃ¡nÃ­</th>
          </tr></thead>
          <tbody>${deps.map((d,i) => depRow(d,i,tm)).join('')}</tbody>
        </table>`
    }`);
}

function depRow(d, i, tm) {
  const route = d.route || {};
  const trip  = d.trip  || {};
  // Timestamps: prefer predicted (real-time) over scheduled
  const ts       = d.departure_timestamp || d.arrival_timestamp || {};
  const displayTs = ts.predicted || ts.scheduled;
  const short    = route.short_name || '?';
  const head     = trip.headsign || 'â€”';
  const rtype    = rType(route.type, short);
  const rcls     = rClass(rtype, short);
  const timeStr  = displayTs ? new Date(displayTs).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}) : '--:--';

  let minsHtml = '';
  if (displayTs) {
    const diff = Math.round((new Date(displayTs) - Date.now()) / 60000);
    minsHtml = diff <= 0  ? `<span class="mins now">NYNÃ</span>`
             : diff <= 2  ? `<span class="mins soon">${diff}'</span>`
             : diff <= 5  ? `<span class="mins near">${diff}'</span>`
             :               `<span class="mins ok">${diff}'</span>`;
  }

  // delay in seconds (can be negative = early)
  const delaySec = d.delay ?? ts.delay ?? null;
  let dlHtml = `<span class="dl" style="opacity:.3">â€”</span>`;
  if (delaySec !== null) {
    const dm = Math.round(delaySec / 60);
    dlHtml = dm >  1 ? `<span class="dl late">+${dm}min</span>`
           : dm < -1 ? `<span class="dl early">${dm}min</span>`
           :            `<span class="dl ok">Â±0</span>`;
  }

  const platform = d.stop?.platform_code || '';
  const acMark   = gcfg('ac',true) && d.vehicle_registration?.air_conditioned ? ' â„ï¸' : '';
  const style    = `animation-delay:${i*32}ms`;

  return `<tr class="drow" data-rt="${rtype.toLowerCase()}" style="${style}">
    <td><span class="rb ${rcls}">${short}</span></td>
    <td>${e(head)}${acMark}</td>
    <td><span style="font:700 12px/1 var(--M)">${timeStr}</span></td>
    ${tm !== 'time' ? `<td>${minsHtml}</td>` : ''}
    <td>${dlHtml}</td>
    <td style="font:400 9px/1 var(--M);color:var(--text3)">${platform}</td>
  </tr>`;
}

function buildTabs(deps) {
  const cnt = {};
  deps.forEach(d => { const t = rType(d.route?.type, d.route?.short_name); cnt[t] = (cnt[t]||0)+1; });
  return Object.entries(cnt).map(([t,c]) =>
    `<button class="ftab" onclick="fDep('${t.toLowerCase()}',this)">${rIcon(t)} ${t} (${c})</button>`
  ).join('');
}

function fDep(type, btn) {
  document.querySelectorAll('.ftab').forEach(t => t.classList.remove('on'));
  btn.classList.add('on');
  document.querySelectorAll('.drow').forEach(r => {
    r.style.display = (type === 'all' || r.dataset.rt === type) ? '' : 'none';
  });
}

function setBoard(html) { document.getElementById('board').innerHTML = html; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer(id, name) {
  stopTimer();
  const iv = parseInt(gcfg('refresh', 30));
  if (!iv) return;
  cd = iv;
  timer = setInterval(() => {
    cd--;
    const rcd  = document.getElementById('rcd');
    const fill = document.getElementById('rfill');
    if (rcd)  rcd.textContent = cd;
    if (fill) fill.style.width = (cd / iv * 100) + '%';
    if (cd <= 0) loadDep(id, name);
  }, 1000);
}
function stopTimer() { if (timer) { clearInterval(timer); timer = null; } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VEHICLES
//  Endpoint: GET /v2/pid/vehiclepositions?limit=50
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadVeh() {
  if (!key) { showErr('eveh','Zadejte API klÃ­Ä.'); return; }
  hideErr('eveh');
  document.getElementById('vboard').innerHTML =
    `<div class="sbox"><div class="spinner"></div><div class="sbox-title">NaÄÃ­tÃ¡m vozidlaâ€¦</div></div>`;
  try {
    const data = await pFetch(`${API}/pid/vehiclepositions?limit=50&includeNotTracking=false`);
    allVeh = data.features || [];
    filterVeh();
  } catch(err) {
    showErr('eveh','Chyba: ' + err.message);
    document.getElementById('vboard').innerHTML =
      `<div class="sbox"><div class="sbox-icon">âš ï¸</div><div class="sbox-title">Chyba</div><div class="sbox-desc">${e(err.message)}</div></div>`;
  }
}

function filterVeh() {
  const q = document.getElementById('vq').value.trim().toUpperCase();
  const list = q ? allVeh.filter(v => (v.properties?.route?.short_name||'').toUpperCase().includes(q)) : allVeh;
  if (!list.length) {
    document.getElementById('vboard').innerHTML =
      `<div class="sbox"><div class="sbox-icon">ğŸšŒ</div><div class="sbox-title">Å½Ã¡dnÃ¡ vozidla</div></div>`;
    return;
  }
  const cards = list.map((v,i) => {
    const p     = v.properties || {};
    const short = p.route?.short_name || '?';
    const rtype = rType(p.route?.type, short);
    const rcls  = rClass(rtype, short);
    const head  = p.trip?.headsign || 'â€”';
    const delay = p.delay != null ? Math.round(p.delay/60) : null;
    const dcls  = delay == null ? '' : delay > 1 ? 'late' : delay < -1 ? 'early' : 'ok';
    const dtxt  = delay == null ? 'â€”' : delay > 0 ? `+${delay}min` : delay < 0 ? `${delay}min` : 'Â±0min';
    const spd   = p.speed   != null ? Math.round(p.speed)+'km/h' : 'â€”';
    const bear  = p.bearing != null ? p.bearing+'Â°' : 'â€”';
    const ac    = p.vehicle_registration?.air_conditioned;
    return `<div class="vc" style="animation-delay:${i*22}ms">
      <div class="vc-hd">
        <div><span class="rb ${rcls}">${rIcon(rtype)} ${short}</span><div class="vc-hs" title="${e(head)}">${e(head)}</div></div>
        <div class="vc-dot"></div>
      </div>
      <div class="vm">
        <div class="vmi"><div class="vml">ZpoÅ¾dÄ›nÃ­</div><div class="vmv ${dcls}">${dtxt}</div></div>
        <div class="vmi"><div class="vml">Rychlost</div><div class="vmv">${spd}</div></div>
        <div class="vmi"><div class="vml">SmÄ›r</div><div class="vmv">${bear}</div></div>
        <div class="vmi"><div class="vml">Klima</div><div class="vmv">${ac ? 'â„ï¸ Ano' : ac === false ? 'Ne' : 'â€”'}</div></div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('vboard').innerHTML =
    `<div style="font:400 9px/1 var(--M);color:var(--text3);margin-bottom:10px">${list.length} vozidel Â· ${new Date().toLocaleTimeString('cs-CZ')}</div>
     <div class="vgrid">${cards}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVED STOPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSaved(id, name) {
  const idx = saved.findIndex(s => s.id === id);
  if (idx >= 0) saved.splice(idx, 1); else saved.push({id, name});
  localStorage.setItem('pid.saved', JSON.stringify(saved));
  const btn = document.getElementById('starBtn');
  if (btn) btn.textContent = saved.some(s => s.id === id) ? 'â­' : 'â˜†';
  renderSaved();
}
function renderSaved() {
  const el = document.getElementById('savedList');
  if (!el) return;
  if (!saved.length) { el.innerHTML = '<div class="s-empty">Å½Ã¡dnÃ© oblÃ­benÃ©</div>'; return; }
  el.innerHTML = saved.map(s => `
    <div class="saved-item${curId===s.id?' cur':''}" onclick="loadDep('${esc(s.id)}','${esc(s.name)}')">
      <div><div class="si-name">ğŸš ${e(s.name)}</div><div class="si-id">${s.id}</div></div>
      <button class="si-rm" onclick="event.stopPropagation();rmSaved('${esc(s.id)}')">âœ•</button>
    </div>`).join('');
}
function rmSaved(id) { saved=saved.filter(s=>s.id!==id); localStorage.setItem('pid.saved',JSON.stringify(saved)); renderSaved(); }
function clearSaved() { saved=[]; localStorage.removeItem('pid.saved'); renderSaved(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gcfg(k,def){ return cfg[k]!=null ? cfg[k] : def; }
function sc(k,v){ cfg[k]=v; localStorage.setItem('pid.cfg',JSON.stringify(cfg)); }
function st(k,el){ const v=!el.classList.contains('on'); el.className='tog'+(v?' on':''); sc(k,v); }
function applyCfg(){
  const r=document.getElementById('cfgR'); if(r) r.value=gcfg('refresh',30);
  const l=document.getElementById('cfgL'); if(l) l.value=gcfg('lim',10);
  const t=document.getElementById('cfgT'); if(t) t.value=gcfg('tm','minutes');
  const sk=document.getElementById('tSkip'); if(sk) sk.className='tog'+(gcfg('skip',true)?' on':'');
  const ac=document.getElementById('tAC');   if(ac) ac.className='tog'+(gcfg('ac',true)?' on':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTE TYPE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rType(n, short) {
  if (n===1||n===401) return 'Metro';
  if (n===0||n===900) return 'Tramvaj';
  if (n===2||n===100||n===102||n===106) return 'Vlak';
  if (n===4)          return 'PÅ™Ã­voz';
  const s = (short||'').toString().toUpperCase();
  if (['A','B','C'].includes(s)) return 'Metro';
  if (/^[PN]\d/.test(s))        return 'NoÄnÃ­';
  return 'Bus';
}
function rClass(type, short) {
  if (type==='Metro') {
    const s=(short||'').toUpperCase();
    return s==='A'?'rb-ma': s==='B'?'rb-mb': s==='C'?'rb-mc': 'rb-mb';
  }
  if (type==='Tramvaj') return 'rb-tram';
  if (type==='Vlak')    return 'rb-train';
  if (type==='PÅ™Ã­voz')  return 'rb-ferry';
  if (type==='NoÄnÃ­')   return 'rb-night';
  return 'rb-bus';
}
function rIcon(t){ return {Metro:'ğŸš‡',Tramvaj:'ğŸšƒ',Vlak:'ğŸš‚',PÅ™Ã­voz:'â›´',NoÄnÃ­:'ğŸŒ™',Bus:'ğŸšŒ'}[t]||'ğŸšŒ'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pFetch(url) {
  if (!key) throw new Error('API klÃ­Ä nenÃ­ nastaven â€” zadejte ho v postrannÃ­m panelu');
  const res = await fetch(url, { headers: { 'X-Access-Token': key } });
  if (!res.ok) {
    let msg = `HTTP ${res.status}`;
    try { const j = await res.json(); msg = j.message || j.error || j.detail || msg; } catch(_) {}
    if (res.status===401) msg = 'NeplatnÃ½ nebo vyprÅ¡elÃ½ API klÃ­Ä (401)';
    if (res.status===403) msg = 'PÅ™Ã­stup odepÅ™en (403) â€” zkontrolujte klÃ­Ä';
    if (res.status===404) msg = 'Endpoint nenalezen (404)';
    if (res.status===429) msg = 'PÅ™Ã­liÅ¡ mnoho poÅ¾adavkÅ¯ (429) â€” zkuste za chvÃ­li';
    throw new Error(msg);
  }
  return res.json();
}
function showErr(id, msg){ const el=document.getElementById(id); if(el){el.textContent='âš ï¸ '+msg; el.style.display='block';}}
function hideErr(id){ const el=document.getElementById(id); if(el) el.style.display='none'; }
function e(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function esc(s){ return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
</script>
</body>
</html>
