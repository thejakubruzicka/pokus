<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PID Odjezdy â€” Jakub RÅ¯Å¾iÄka</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&display=swap" rel="stylesheet">
<style>
/* â•â•â• THEMES â•â•â• */
:root{
  --bg:#0a0c10;--bg2:#111318;--bg3:#1a1d24;--bd:#252932;
  --tx:#e8eaf0;--tx2:#8a8f9e;--tx3:#545966;
  --ac:#f5c842;--ac2:#ff6b35;--ac3:#4ea8ff;
  --g:#44d986;--r:#ff4f4f;--o:#ff9f40;
  --ma:#00a562;--mb:#f5c842;--mc:#c8102e;
  --R:10px;--M:'Space Mono',monospace;--S:'DM Sans',sans-serif;--T:.18s ease;
}
[data-theme="light"]{--bg:#f0ede6;--bg2:#fff;--bg3:#e8e4db;--bd:#d5cfc4;--tx:#1a1a1a;--tx2:#5a5a6a;--tx3:#9a9aaa;--ac:#c89a00;--ac2:#d44010;--ac3:#0055cc;}
[data-theme="tram"]{--bg:#0c1a0e;--bg2:#112014;--bg3:#162b1a;--bd:#1d3422;--tx:#d0f5d8;--tx2:#60b070;--tx3:#386440;--ac:#44d986;--ac2:#90ff60;--ac3:#60ffd0;}
[data-theme="metro"]{--bg:#04060f;--bg2:#070b1c;--bg3:#0c1230;--bd:#13193e;--tx:#bcd4ff;--tx2:#5870a4;--tx3:#303c60;--ac:#4ea8ff;--ac2:#9060ff;--ac3:#ff50a0;}
[data-theme="terminal"]{--bg:#000;--bg2:#040404;--bg3:#080808;--bd:#141414;--tx:#00ff41;--tx2:#007718;--tx3:#003c0c;--ac:#00ff41;--ac2:#00cc33;--ac3:#009926;}

*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--tx);font-family:var(--S);min-height:100vh;transition:background var(--T),color var(--T);}

/* â•â•â• LAYOUT â•â•â• */
.layout{display:grid;grid-template-columns:265px 1fr;grid-template-rows:56px 1fr;min-height:100vh;}

/* HEADER */
header{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--bd);padding:0 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
.logo{display:flex;align-items:center;gap:10px;}
.logo-ic{width:32px;height:32px;background:var(--ac);border-radius:7px;display:flex;align-items:center;justify-content:center;font:700 12px/1 var(--M);color:#000;flex-shrink:0;}
.logo-nm{font:700 13px/1 var(--M);}
.logo-sb{font:400 9px/1 var(--M);color:var(--tx3);letter-spacing:.07em;text-transform:uppercase;margin-top:3px;}
.hr{display:flex;align-items:center;gap:9px;}
.live{display:flex;align-items:center;gap:5px;background:rgba(68,217,134,.1);border:1px solid rgba(68,217,134,.22);border-radius:20px;padding:3px 9px;font:400 10px/1 var(--M);color:var(--g);}
.ld{width:5px;height:5px;border-radius:50%;background:var(--g);animation:bl 1.4s ease infinite;}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.3}}
#clock{font:400 13px/1 var(--M);color:var(--tx2);}
.tpick{display:flex;gap:3px;background:var(--bg3);border:1px solid var(--bd);border-radius:7px;padding:3px;}
.tb{width:19px;height:19px;border-radius:4px;border:2px solid transparent;cursor:pointer;transition:transform .13s,border-color .13s;position:relative;}
.tb:hover{transform:scale(1.3);}
.tb.on{border-color:var(--ac);}
.tb[data-t="dark"]{background:#111318;}
.tb[data-t="light"]{background:#f0ede6;}
.tb[data-t="tram"]{background:#112014;}
.tb[data-t="metro"]{background:#070b1c;}
.tb[data-t="terminal"]{background:#000;}
.tbt{position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--bd);border-radius:4px;padding:2px 6px;font:400 9px/1 var(--M);white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .12s;}
.tb:hover .tbt{opacity:1;}

/* SIDEBAR */
.sidebar{background:var(--bg2);border-right:1px solid var(--bd);overflow-y:auto;padding:16px 0;}
.ss{padding:0 13px;margin-bottom:18px;}
.sl{font:400 9px/1 var(--M);letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);padding:0 8px;margin-bottom:6px;display:block;}
.nb{width:100%;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;border:none;background:transparent;color:var(--tx2);cursor:pointer;font:500 13px/1 var(--S);transition:background var(--T),color var(--T);text-align:left;margin-bottom:2px;}
.nb:hover{background:var(--bg3);color:var(--tx);}
.nb.on{background:rgba(245,200,66,.1);color:var(--ac);}
.ni{font-size:14px;width:17px;text-align:center;}
.ai{width:100%;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;padding:6px 8px;color:var(--tx);font:400 10px/1 var(--M);outline:none;transition:border-color var(--T);}
.ai:focus{border-color:var(--ac);}
.ai::placeholder{color:var(--tx3);}
.ab{width:100%;margin-top:4px;padding:6px;background:var(--ac);color:#000;border:none;border-radius:6px;font:700 10px/1 var(--M);cursor:pointer;transition:opacity var(--T);}
.ab:hover{opacity:.8;}
.ast{font:400 9px/1 var(--M);margin-top:4px;padding:0 2px;}
.ast.ok{color:var(--g);}
.ast.err{color:var(--r);}
.svi{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background var(--T);margin-bottom:2px;}
.svi:hover{background:var(--bg3);}
.svi.cur{background:rgba(245,200,66,.08);}
.sn{font:500 12px/1.2 var(--S);}
.sid{font:400 9px/1 var(--M);color:var(--tx3);margin-top:2px;}
.srm{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:12px;border-radius:3px;transition:color var(--T);padding:2px 3px;}
.srm:hover{color:var(--r);}
.sem{padding:5px 10px;font:italic 11px/1 var(--S);color:var(--tx3);}

/* MAIN */
.main{overflow-y:auto;padding:20px;background:var(--bg);}
.page{display:none;}
.page.on{display:block;animation:fi .2s ease;}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH */
.sbar{display:flex;gap:8px;margin-bottom:7px;}
.sinp{flex:1;background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);padding:10px 14px;color:var(--tx);font:400 14px/1 var(--S);outline:none;transition:border-color var(--T);}
.sinp:focus{border-color:var(--ac);}
.sinp::placeholder{color:var(--tx3);}
.sbtn{padding:10px 16px;background:var(--ac);color:#000;border:none;border-radius:var(--R);font:700 12px/1 var(--M);cursor:pointer;transition:opacity var(--T),transform .1s;white-space:nowrap;}
.sbtn:hover{opacity:.82;}
.sbtn:active{transform:scale(.96);}
.sdrop{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);overflow:hidden;margin-bottom:13px;display:none;max-height:260px;overflow-y:auto;z-index:50;position:relative;}
.sri{padding:9px 14px;cursor:pointer;transition:background var(--T);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);}
.sri:last-child{border-bottom:none;}
.sri:hover{background:var(--bg3);}
.srn{font:500 13px/1 var(--S);}
.srm2{font:400 10px/1 var(--M);color:var(--tx3);margin-top:3px;}
.errbox{background:rgba(255,79,79,.1);border:1px solid rgba(255,79,79,.28);border-radius:8px;padding:10px 13px;font:400 12px/1.4 var(--S);color:var(--r);margin-bottom:13px;display:none;}

/* BOARD */
.bh{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:13px;}
.bt{font:700 19px/1.2 var(--M);letter-spacing:-.02em;}
.bs{font:400 10px/1 var(--M);color:var(--tx3);margin-top:4px;}
.ba{display:flex;gap:6px;}
.icb{width:32px;height:32px;background:var(--bg2);border:1px solid var(--bd);border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--tx2);transition:all var(--T);}
.icb:hover{background:var(--bg3);color:var(--tx);border-color:var(--ac);}

/* REFRESH BAR */
.rb2{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);padding:8px 12px;margin-bottom:13px;display:flex;align-items:center;gap:10px;}
.rl{font:400 10px/1 var(--M);color:var(--tx2);white-space:nowrap;}
.rp{flex:1;height:2px;background:var(--bd);border-radius:1px;overflow:hidden;}
.rf{height:100%;background:var(--ac);border-radius:1px;transition:width 1s linear;}

/* FILTER TABS */
.ftabs{display:flex;gap:5px;margin-bottom:16px;flex-wrap:wrap;}
.ft{padding:4px 11px;border-radius:20px;border:1px solid var(--bd);background:var(--bg2);color:var(--tx2);font:400 10px/1 var(--M);cursor:pointer;transition:all var(--T);}
.ft:hover{border-color:var(--ac);color:var(--tx);}
.ft.on{background:var(--ac);color:#000;border-color:var(--ac);font-weight:700;}

/* DEP TABLE */
.dt{width:100%;border-collapse:collapse;font-size:13px;}
.dt thead tr{border-bottom:1px solid var(--bd);}
.dt th{text-align:left;padding:6px 10px;font:400 9px/1 var(--M);letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);}
.dr{border-bottom:1px solid var(--bd);transition:background var(--T);animation:ri .28s ease forwards;opacity:0;}
.dr:hover{background:var(--bg2);}
@keyframes ri{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.dr td{padding:9px 10px;vertical-align:middle;}

/* ROUTE BADGE */
.rbl{display:inline-flex;align-items:center;justify-content:center;min-width:36px;padding:3px 6px;border-radius:5px;font:700 11px/1 var(--M);}
.rb-bus{background:rgba(78,168,255,.14);color:var(--ac3);}
.rb-tram{background:rgba(255,107,53,.14);color:var(--ac2);}
.rb-ma{background:rgba(0,165,98,.18);color:var(--ma);}
.rb-mb{background:rgba(245,200,66,.18);color:var(--mb);}
.rb-mc{background:rgba(200,16,46,.18);color:var(--mc);}
.rb-night{background:rgba(138,143,158,.14);color:var(--tx2);}
.rb-train{background:rgba(180,100,255,.14);color:#b464ff;}
.rb-ferry{background:rgba(0,200,255,.14);color:#00c8ff;}

/* MINUTES PILL */
.mn{display:inline-block;font:700 11px/1 var(--M);padding:2px 6px;border-radius:4px;}
.mn.now{background:var(--ac);color:#000;animation:fla 1s ease infinite;}
.mn.soon{background:rgba(255,79,79,.14);color:var(--r);}
.mn.near{background:rgba(255,159,64,.14);color:var(--o);}
.mn.ok{background:rgba(68,217,134,.11);color:var(--g);}
@keyframes fla{0%,100%{opacity:1}50%{opacity:.5}}
.dl{font:400 10px/1 var(--M);}
.dl.late{color:var(--r);}
.dl.early{color:var(--ac3);}
.dl.ok{color:var(--g);}

/* STATE BOX */
.stb{padding:52px 20px;text-align:center;color:var(--tx3);}
.sti{font-size:42px;margin-bottom:13px;opacity:.45;}
.stt{font:700 16px/1 var(--M);color:var(--tx2);margin-bottom:7px;}
.std{font:400 12px/1.6 var(--S);max-width:380px;margin:0 auto;}
.spin{width:28px;height:28px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:sp .75s linear infinite;margin:0 auto 13px;}
@keyframes sp{to{transform:rotate(360deg)}}

/* VEHICLES */
.vg{display:grid;grid-template-columns:repeat(auto-fill,minmax(255px,1fr));gap:12px;margin-top:16px;}
.vc{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);padding:14px;transition:border-color var(--T),transform .14s;animation:ri .28s ease forwards;opacity:0;}
.vc:hover{border-color:var(--ac);transform:translateY(-2px);}
.vch{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.vhs{font:700 13px/1.2 var(--S);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:148px;}
.vdt{width:6px;height:6px;border-radius:50%;background:var(--g);animation:bl 1.4s ease infinite;margin-top:5px;}
.vm{display:grid;grid-template-columns:1fr 1fr;gap:6px;font:400 9px/1 var(--M);}
.vmi{background:var(--bg3);border-radius:5px;padding:5px 6px;}
.vml{color:var(--tx3);margin-bottom:2px;}
.vmv{color:var(--tx);font-weight:700;}
.vmv.late{color:var(--r);}
.vmv.ok2{color:var(--g);}
.vmv.early{color:var(--ac3);}

/* ABOUT / SETTINGS */
.pg-title{font:700 18px/1 var(--M);margin-bottom:4px;letter-spacing:-.02em;}
.pg-sub{font:400 12px/1 var(--S);color:var(--tx3);margin-bottom:20px;}
.card{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);padding:20px;margin-bottom:14px;}
.ct{font:400 10px/1 var(--M);letter-spacing:.08em;text-transform:uppercase;color:var(--ac);margin-bottom:14px;display:flex;align-items:center;gap:6px;}
.ct::after{content:'';flex:1;height:1px;background:var(--bd);}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.fi{display:flex;align-items:flex-start;gap:8px;padding:8px;background:var(--bg3);border-radius:6px;}
.fico{font-size:16px;margin-top:1px;}
.fit h4{font:700 11px/1 var(--S);margin-bottom:2px;}
.fit p{font:400 10px/1.35 var(--S);color:var(--tx2);}
.clr{display:flex;gap:13px;padding:11px 0;border-bottom:1px solid var(--bd);}
.clr:last-child{border-bottom:none;}
.clv{font:700 10px/1 var(--M);color:var(--ac);white-space:nowrap;min-width:40px;}
.cld{font:400 9px/1 var(--M);color:var(--tx3);margin-top:2px;}
.cle h4{font:700 11px/1 var(--S);margin-bottom:3px;}
.cle ul{padding-left:13px;}
.cle li{font:400 10px/1.5 var(--S);color:var(--tx2);margin-bottom:1px;}
.tag{display:inline-block;padding:1px 5px;border-radius:3px;font:700 8px/1 var(--M);margin-right:3px;}
.tn{background:rgba(68,217,134,.14);color:var(--g);}
.tf{background:rgba(255,79,79,.14);color:var(--r);}
.ti{background:rgba(78,168,255,.14);color:var(--ac3);}
.setr{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:6px;margin-bottom:7px;flex-wrap:wrap;gap:7px;}
.setr:last-child{margin-bottom:0;}
.setl h4{font:500 12px/1 var(--S);}
.setl p{font:400 9px/1 var(--S);color:var(--tx3);margin-top:2px;}
.tog{width:36px;height:18px;background:var(--bd);border-radius:9px;position:relative;cursor:pointer;transition:background var(--T);flex-shrink:0;}
.tog.on{background:var(--ac);}
.tog::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:2px;left:2px;transition:left var(--T);}
.tog.on::after{left:20px;}
.csel{background:var(--bg2);border:1px solid var(--bd);border-radius:5px;padding:4px 6px;color:var(--tx);font:400 10px/1 var(--M);outline:none;cursor:pointer;}

/* ABOUT HERO */
.ah{background:var(--bg2);border:1px solid var(--bd);border-radius:var(--R);padding:26px;margin-bottom:14px;position:relative;overflow:hidden;}
.ah::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,200,66,.06) 0%,transparent 70%);pointer-events:none;}
.aht{font:700 24px/1.1 var(--M);letter-spacing:-.03em;margin-bottom:7px;}
.aht span{color:var(--ac);}
.ahd{font:400 13px/1.7 var(--S);color:var(--tx2);}
.ahl{margin-top:16px;display:flex;gap:6px;flex-wrap:wrap;}
.aln{display:inline-flex;align-items:center;gap:5px;padding:6px 11px;background:var(--bg3);border:1px solid var(--bd);border-radius:6px;font:400 10px/1 var(--M);color:var(--tx2);text-decoration:none;transition:border-color var(--T),color var(--T);}
.aln:hover{border-color:var(--ac);color:var(--ac);}
.authr{display:inline-flex;align-items:center;gap:10px;background:var(--bg3);border:1px solid var(--bd);border-radius:8px;padding:11px 14px;margin-top:14px;}
.av{width:34px;height:34px;background:var(--ac);border-radius:50%;display:flex;align-items:center;justify-content:center;font:700 13px/1 var(--M);color:#000;flex-shrink:0;}
.an{font:700 12px/1.3 var(--S);}
.ag{font:400 10px/1 var(--M);color:var(--tx3);}
.ag a{color:var(--ac3);text-decoration:none;}
.ag a:hover{text-decoration:underline;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--tx3);}

@media(max-width:700px){
  .layout{grid-template-columns:1fr;grid-template-rows:56px auto 1fr;}
  .sidebar{flex-direction:row;border-right:none;border-bottom:1px solid var(--bd);padding:8px 0;overflow-x:auto;display:flex;}
  .ss{margin-bottom:0;}
  .sl,.api-area,.saved-area{display:none;}
  .nb{width:auto;white-space:nowrap;}
  .fg{grid-template-columns:1fr;}
  #clock{display:none;}
}
</style>
</head>
<body data-theme="dark">
<div class="layout">

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-ic">PID</div>
    <div>
      <div class="logo-nm">OdjezdovÃ¡ tabule</div>
      <div class="logo-sb">CIS Â· Golemio API v2</div>
    </div>
  </div>
  <div class="hr">
    <div class="live"><div class="ld"></div>Å½IVÄš</div>
    <div id="clock">--:--:--</div>
    <div class="tpick">
      <button class="tb on" data-t="dark"     onclick="setTheme('dark')"><span class="tbt">NoÄnÃ­</span></button>
      <button class="tb"    data-t="light"    onclick="setTheme('light')"><span class="tbt">DennÃ­</span></button>
      <button class="tb"    data-t="tram"     onclick="setTheme('tram')"><span class="tbt">Tramvaj</span></button>
      <button class="tb"    data-t="metro"    onclick="setTheme('metro')"><span class="tbt">Metro</span></button>
      <button class="tb"    data-t="terminal" onclick="setTheme('terminal')"><span class="tbt">TerminÃ¡l</span></button>
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="ss">
    <span class="sl">Navigace</span>
    <button class="nb on" onclick="goPage('dep',this)"><span class="ni">ğŸš</span>Odjezdy</button>
    <button class="nb"    onclick="goPage('veh',this)"><span class="ni">ğŸšŒ</span>Vozidla</button>
    <button class="nb"    onclick="goPage('set',this)"><span class="ni">âš™ï¸</span>NastavenÃ­</button>
    <button class="nb"    onclick="goPage('abo',this)"><span class="ni">â„¹ï¸</span>O aplikaci</button>
  </div>
  <div class="ss api-area">
    <span class="sl">Golemio API klÃ­Ä</span>
    <input class="ai" type="password" id="apiKey" placeholder="VloÅ¾te klÃ­Äâ€¦" autocomplete="off">
    <button class="ab" onclick="saveKey()">ğŸ’¾ UloÅ¾it klÃ­Ä</button>
    <div class="ast" id="keySt"></div>
    <div style="margin-top:7px;font:400 9px/1.6 var(--M);color:var(--tx3)">
      KlÃ­Ä zdarma na:<br>
      <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--ac3);text-decoration:none">api.golemio.cz â†’</a>
    </div>
  </div>
  <div class="ss saved-area">
    <span class="sl">OblÃ­benÃ© zastÃ¡vky</span>
    <div id="savedList"></div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

<!-- â”€â”€â”€ ODJEZDY â”€â”€â”€ -->
<div class="page on" id="page-dep">
  <div class="sbar">
    <input class="sinp" id="q" type="text"
      placeholder="Hledat zastÃ¡vku (napÅ™. AndÄ›l, Muzeum, HlavnÃ­ nÃ¡draÅ¾Ã­â€¦)"
      oninput="debSrch()" onkeydown="if(event.key==='Enter')doSrch()">
    <button class="sbtn" onclick="doSrch()">ğŸ” Hledat</button>
  </div>
  <div class="sdrop" id="sdrop"></div>
  <div class="errbox" id="edep"></div>
  <div id="board">
    <div class="stb">
      <div class="sti">ğŸš</div>
      <div class="stt">Vyhledejte zastÃ¡vku</div>
      <div class="std">NapiÅ¡te nÃ¡zev zastÃ¡vky a stisknÄ›te Enter nebo vyberte ze seznamu. API klÃ­Ä zadejte vlevo.</div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ VOZIDLA â”€â”€â”€ -->
<div class="page" id="page-veh">
  <div class="pg-title">ğŸšŒ Vozidla v provozu</div>
  <div class="pg-sub">Å½ivÃ© polohy vozidel PID â€” vyÅ¾aduje API klÃ­Ä</div>
  <div class="sbar">
    <input class="sinp" id="vq" type="text" placeholder="Filtrovat dle linky (22, A, 207)â€¦" oninput="filtV()">
    <button class="sbtn" onclick="loadV()">âŸ³ NaÄÃ­st</button>
  </div>
  <div class="errbox" id="eveh"></div>
  <div id="vb">
    <div class="stb"><div class="sti">ğŸ—ºï¸</div><div class="stt">KliknÄ›te na NaÄÃ­st</div><div class="std">ZobrazÃ­ polohy a zpoÅ¾dÄ›nÃ­ vozidel PID.</div></div>
  </div>
</div>

<!-- â”€â”€â”€ NASTAVENÃ â”€â”€â”€ -->
<div class="page" id="page-set">
  <div class="pg-title">âš™ï¸ NastavenÃ­</div>
  <div class="pg-sub">PÅ™izpÅ¯sobte si aplikaci</div>
  <div class="card">
    <div class="ct">Odjezdy</div>
    <div class="setr"><div class="setl"><h4>AutomatickÃ© obnovenÃ­</h4><p>Interval obnovenÃ­</p></div>
      <select class="csel" id="cfgR" onchange="sc('r',this.value)">
        <option value="20">20s</option><option value="30" selected>30s</option>
        <option value="45">45s</option><option value="60">60s</option><option value="0">Vypnout</option>
      </select></div>
    <div class="setr"><div class="setl"><h4>PoÄet odjezdÅ¯</h4><p>MaximÃ¡lnÃ­ poÄet najednou</p></div>
      <select class="csel" id="cfgL" onchange="sc('l',this.value)">
        <option value="5">5</option><option value="10" selected>10</option>
        <option value="15">15</option><option value="20">20</option>
      </select></div>
    <div class="setr"><div class="setl"><h4>PÅ™eskoÄit "u zastÃ¡vky"</h4><p>Nezobrazit prÃ¡vÄ› odjÃ­Å¾dÄ›jÃ­cÃ­</p></div>
      <div class="tog on" id="tSkip" onclick="st('sk',this)"></div></div>
    <div class="setr"><div class="setl"><h4>Klimatizace â„ï¸</h4><p>Ikona u vybavenÃ½ch vozidel</p></div>
      <div class="tog on" id="tAC" onclick="st('ac',this)"></div></div>
    <div class="setr"><div class="setl"><h4>ZobrazenÃ­ Äasu</h4><p>Minuty nebo Äas odjezdu</p></div>
      <select class="csel" id="cfgT" onchange="sc('tm',this.value)">
        <option value="m" selected>Minuty</option><option value="t">ÄŒas odjezdu</option><option value="b">ObojÃ­</option>
      </select></div>
  </div>
  <div class="card">
    <div class="ct">TÃ©ma</div>
    <div class="setr">
      <div class="setl"><h4>BarevnÃ© schÃ©ma</h4></div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        <button onclick="setTheme('dark')"     class="sbtn" style="padding:5px 9px;font-size:10px">ğŸŒ™ NoÄnÃ­</button>
        <button onclick="setTheme('light')"    class="sbtn" style="padding:5px 9px;font-size:10px;background:var(--bg3);color:var(--tx)">â˜€ï¸ DennÃ­</button>
        <button onclick="setTheme('tram')"     class="sbtn" style="padding:5px 9px;font-size:10px;background:rgba(68,217,134,.18);color:var(--g)">ğŸšƒ Tramvaj</button>
        <button onclick="setTheme('metro')"    class="sbtn" style="padding:5px 9px;font-size:10px;background:rgba(78,168,255,.18);color:var(--ac3)">ğŸš‡ Metro</button>
        <button onclick="setTheme('terminal')" class="sbtn" style="padding:5px 9px;font-size:10px;background:#000;color:#00ff41">ğŸ’» TerminÃ¡l</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="ct">Data</div>
    <div class="setr"><div class="setl"><h4>Smazat oblÃ­benÃ©</h4><p>OdstranÃ­ uloÅ¾enÃ© zastÃ¡vky</p></div>
      <button onclick="clrSaved()" style="padding:4px 9px;font:700 10px/1 var(--M);background:rgba(255,79,79,.14);color:var(--r);border:1px solid rgba(255,79,79,.28);border-radius:5px;cursor:pointer">Smazat</button></div>
    <div class="setr"><div class="setl"><h4>Smazat API klÃ­Ä</h4><p>OdstranÃ­ z pamÄ›ti prohlÃ­Å¾eÄe</p></div>
      <button onclick="clrKey()" style="padding:4px 9px;font:700 10px/1 var(--M);background:rgba(255,79,79,.14);color:var(--r);border:1px solid rgba(255,79,79,.28);border-radius:5px;cursor:pointer">Smazat</button></div>
  </div>
</div>

<!-- â”€â”€â”€ O APLIKACI â”€â”€â”€ -->
<div class="page" id="page-abo" style="max-width:680px">
  <div class="ah">
    <div class="aht">PID <span>OdjezdovÃ¡</span><br>Tabule</div>
    <div class="ahd">WebovÃ¡ aplikace pro Å¾ivÃ© odjezdy PraÅ¾skÃ© integrovanÃ© dopravy pomocÃ­ <strong>Golemio API v2</strong> a systÃ©mu <strong>CIS</strong>.</div>
    <div class="ahl">
      <a class="aln" href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank">ğŸ”‘ ZÃ­skat API klÃ­Ä</a>
      <a class="aln" href="https://api.golemio.cz/v2/pid/docs/openapi/" target="_blank">ğŸ“– API Dokumentace</a>
      <a class="aln" href="https://pid.cz/o-systemu/opendata/" target="_blank">ğŸ“Š Opendata PID</a>
    </div>
    <div class="authr">
      <div class="av">JR</div>
      <div>
        <div class="an">Jakub RÅ¯Å¾iÄka</div>
        <div class="ag">GitHub: <a href="https://github.com/thejakubruzicka" target="_blank">@thejakubruzicka</a></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ct">Jak zaÄÃ­t</div>
    <div style="font:400 12px/1.9 var(--S);color:var(--tx2)">
      <strong style="color:var(--tx)">1.</strong> Zaregistrujte se na <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--ac3);text-decoration:none">api.golemio.cz</a> a zÃ­skejte bezplatnÃ½ API klÃ­Ä.<br>
      <strong style="color:var(--tx)">2.</strong> VloÅ¾te klÃ­Ä do pole v levÃ©m panelu a kliknÄ›te <em>UloÅ¾it klÃ­Ä</em>.<br>
      <strong style="color:var(--tx)">3.</strong> PÅ™ejdÄ›te na <em>Odjezdy</em> a hledejte zastÃ¡vku (min. 2 znaky).<br>
      <strong style="color:var(--tx)">4.</strong> UloÅ¾te oblÃ­benÃ© zastÃ¡vky kliknutÃ­m na â­ u tabule.<br>
      <strong style="color:var(--tx)">5.</strong> PÅ™izpÅ¯sobte si aplikaci v sekci <em>NastavenÃ­</em>.
    </div>
  </div>

  <div class="card">
    <div class="ct">Funkce</div>
    <div class="fg">
      <div class="fi"><div class="fico">ğŸš</div><div class="fit"><h4>Å½ivÃ© odjezdy</h4><p>ReÃ¡lnÃ¡ data z Golemio API s auto-obnovenÃ­m</p></div></div>
      <div class="fi"><div class="fico">ğŸ”</div><div class="fit"><h4>HledÃ¡nÃ­ zastÃ¡vek</h4><p>FulltextovÃ© hledÃ¡nÃ­ z PID databÃ¡ze zastÃ¡vek</p></div></div>
      <div class="fi"><div class="fico">ğŸšŒ</div><div class="fit"><h4>PÅ™ehled vozidel</h4><p>Polohy a zpoÅ¾dÄ›nÃ­ vozidel v provozu</p></div></div>
      <div class="fi"><div class="fico">â­</div><div class="fit"><h4>OblÃ­benÃ© zastÃ¡vky</h4><p>RychlÃ½ pÅ™Ã­stup z postrannÃ­ho panelu</p></div></div>
      <div class="fi"><div class="fico">ğŸ¨</div><div class="fit"><h4>5 tÃ©mat</h4><p>NoÄnÃ­ Â· DennÃ­ Â· Tramvaj Â· Metro Â· TerminÃ¡l</p></div></div>
      <div class="fi"><div class="fico">ğŸ”„</div><div class="fit"><h4>Auto-obnovenÃ­</h4><p>NastavitelnÃ½ interval 20â€“60 sekund</p></div></div>
    </div>
  </div>

  <div class="card">
    <div class="ct">Changelog</div>
    <div class="clr">
      <div><div class="clv">v2.3</div><div class="cld">Feb 2026</div></div>
      <div class="cle"><h4><span class="tag tf">OPRAVA</span>Opraveny API endpointy â€” koneÄnÄ›!</h4>
        <ul>
          <li>VyhledÃ¡vÃ¡nÃ­ zastÃ¡vek pÅ™es PID XML databÃ¡zi (data.pid.cz) â€” spolehlivÃ© a bez auth</li>
          <li>SprÃ¡vnÃ¡ URL: <code>/v2/pid/departureboards/</code> <strong>se</strong> lomÃ­tkem na konci</li>
          <li>SprÃ¡vnÃ© parametry: <code>ids=</code> (gtfsId z XML) + <code>total=</code> (ne limit=)</li>
          <li>Vozidla: <code>/v2/pid/vehiclepositions/</code> se lomÃ­tkem</li>
          <li>Autor projektu: Jakub RÅ¯Å¾iÄka (@thejakubruzicka)</li>
        </ul>
      </div>
    </div>
    <div class="clr">
      <div><div class="clv">v2.0</div><div class="cld">Feb 2026</div></div>
      <div class="cle"><h4><span class="tag tn">NOVÃ‰</span>KompletnÃ­ pÅ™epracovÃ¡nÃ­ UI</h4>
        <ul>
          <li>5 barevnÃ½ch tÃ©mat, Vozidla, NastavenÃ­, O aplikaci</li>
          <li>Progress bar, filtrace dle typu, zobrazenÃ­ zpoÅ¾dÄ›nÃ­</li>
        </ul>
      </div>
    </div>
    <div class="clr">
      <div><div class="clv">v1.0</div><div class="cld">Sep 2025</div></div>
      <div class="cle"><h4><span class="tag tn">NOVÃ‰</span>PrvnÃ­ vydÃ¡nÃ­</h4>
        <ul><li>ZÃ¡kladnÃ­ odjezdovÃ¡ tabule s podporou MHD, tramvajÃ­, metra a vlakÅ¯</li></ul>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ct">TechnickÃ© info</div>
    <div style="font:400 9px/1.9 var(--M);color:var(--tx3)">
      HledÃ¡nÃ­:&nbsp; PID XML â€” http://data.pid.cz/stops/xml/StopsByName.xml (veÅ™ejnÃ©, bez auth)<br>
      Odjezdy:&nbsp; GET /v2/pid/departureboards/?ids=&lt;gtfsId&gt;&amp;total=N&amp;minutesAfter=120<br>
      Vozidla:&nbsp; GET /v2/pid/vehiclepositions/?limit=50<br>
      Auth:&nbsp;&nbsp;&nbsp;&nbsp; X-Access-Token header Â· Data Â© OperÃ¡tor ICT, a.s.
    </div>
  </div>
</div>

</main>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// âš ï¸ CORRECT URLs â€” trailing slash is REQUIRED by Golemio
const DEP_URL = 'https://api.golemio.cz/v2/pid/departureboards/';
const VEH_URL = 'https://api.golemio.cz/v2/pid/vehiclepositions/';
// Stop search: public PID XML, no auth needed
const STOPS_XML = 'https://data.pid.cz/stops/xml/StopsByName.xml';

let apiKey  = localStorage.getItem('pid.k') || '';
let cfg     = JSON.parse(localStorage.getItem('pid.cfg') || '{}');
let saved   = JSON.parse(localStorage.getItem('pid.sv') || '[]');
let curId   = '', curName = '';
let timer   = null, cd = 30;
let allVeh  = [];

// Loaded stop list from PID XML
let stopList = []; // [{name, gtfsId, zoneId, types}]

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', () => {
  setInterval(() => {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('cs-CZ');
  }, 1000);

  if (apiKey) {
    document.getElementById('apiKey').value = apiKey;
    setKSt('ok', 'âœ“ KlÃ­Ä naÄten');
  }

  applyCfg();
  renderSaved();

  const t = localStorage.getItem('pid.th');
  if (t) setTheme(t);

  // Pre-load stop list in background
  loadStopList();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOP LIST â€” PID XML
   Parses http://data.pid.cz/stops/xml/StopsByName.xml
   Each <Stop> has <Name>, <gtfsIds> (comma-separated), <ZoneId>, <IsMetro> etc.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadStopList() {
  if (stopList.length > 0) return;
  try {
    const res  = await fetch(STOPS_XML);
    const text = await res.text();
    const parser = new DOMParser();
    const xml  = parser.parseFromString(text, 'application/xml');
    const stops = xml.querySelectorAll('Stop');
    stopList = [];
    stops.forEach(s => {
      const name    = s.querySelector('Name')?.textContent?.trim() || '';
      const gtfsRaw = s.querySelector('gtfsIds')?.textContent?.trim() || '';
      const gtfsIds = gtfsRaw.split(',').map(x => x.trim()).filter(Boolean);
      const zone    = s.querySelector('ZoneId')?.textContent?.trim() || '';
      const isMet   = s.querySelector('IsMetro')?.textContent?.trim() === 'true';
      const isTram  = s.querySelector('IsTram')?.textContent?.trim() === 'true';
      const isTrain = s.querySelector('IsTrain')?.textContent?.trim() === 'true';
      const isFerry = s.querySelector('IsFerry')?.textContent?.trim() === 'true';
      if (name && gtfsIds.length) {
        stopList.push({ name, gtfsIds, zone, isMet, isTram, isTrain, isFerry });
      }
    });
    console.log(`[PID] NaÄteno ${stopList.length} zastÃ¡vek z PID XML`);
  } catch (err) {
    console.warn('[PID] Nelze naÄÃ­st XML zastÃ¡vek:', err);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setTheme(t) {
  document.body.dataset.theme = t;
  document.querySelectorAll('.tb').forEach(b => b.classList.toggle('on', b.dataset.t === t));
  localStorage.setItem('pid.th', t);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goPage(p, btn) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(x => x.classList.remove('on'));
  document.getElementById('page-' + p).classList.add('on');
  if (btn) btn.classList.add('on');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveKey() {
  const v = document.getElementById('apiKey').value.trim();
  if (!v) { setKSt('err', 'âœ— PrÃ¡zdnÃ½ klÃ­Ä'); return; }
  apiKey = v; localStorage.setItem('pid.k', apiKey); setKSt('ok', 'âœ“ UloÅ¾en');
}
function clrKey() {
  apiKey = ''; localStorage.removeItem('pid.k');
  document.getElementById('apiKey').value = ''; setKSt('ok', 'âœ“ SmazÃ¡n');
}
function setKSt(cls, msg) {
  const el = document.getElementById('keySt');
  el.textContent = msg; el.className = 'ast ' + cls;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOP SEARCH (uses PID XML, no API key)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _dt = null;
function debSrch() { clearTimeout(_dt); _dt = setTimeout(doSrch, 350); }

async function doSrch() {
  const q   = document.getElementById('q').value.trim().toLowerCase();
  const drop = document.getElementById('sdrop');
  if (q.length < 2) { drop.style.display = 'none'; return; }
  hideErr('edep');

  // Ensure stop list is loaded
  if (stopList.length === 0) {
    drop.innerHTML = `<div class="sri"><span class="srn" style="color:var(--tx3)">NaÄÃ­tÃ¡m databÃ¡zi zastÃ¡vekâ€¦</span></div>`;
    drop.style.display = 'block';
    await loadStopList();
  }

  if (stopList.length === 0) {
    showErr('edep', 'Nelze naÄÃ­st databÃ¡zi zastÃ¡vek (data.pid.cz). Zkontrolujte pÅ™ipojenÃ­.');
    drop.style.display = 'none';
    return;
  }

  // Filter stops by name
  const hits = stopList
    .filter(s => s.name.toLowerCase().includes(q))
    .slice(0, 10);

  if (!hits.length) {
    drop.innerHTML = `<div class="sri"><span class="srn" style="color:var(--tx3)">Å½Ã¡dnÃ© vÃ½sledky pro â€${esc2(q)}"</span></div>`;
    drop.style.display = 'block';
    return;
  }

  drop.innerHTML = hits.map(s => {
    const icon = s.isMet ? 'ğŸš‡' : s.isTram ? 'ğŸšƒ' : s.isTrain ? 'ğŸš‚' : s.isFerry ? 'â›´' : 'ğŸšŒ';
    // Use first gtfsId for display; loadDep will join all gtfsIds
    const id = s.gtfsIds[0];
    const allIds = s.gtfsIds.join(',');
    const zn = s.zone ? `Â· ZÃ³na ${s.zone}` : '';
    return `<div class="sri" onclick="loadDep('${esc(allIds)}','${esc(s.name)}')">
      <div>
        <div class="srn">${icon} ${esc2(s.name)}</div>
        <div class="srm2">${esc2(id)} ${zn}</div>
      </div>
      <span style="color:var(--tx3);font-size:12px">â€º</span>
    </div>`;
  }).join('');
  drop.style.display = 'block';
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('#sdrop') && !e.target.closest('#q')) {
    document.getElementById('sdrop').style.display = 'none';
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEPARTURE BOARD
   Endpoint: GET /v2/pid/departureboards/
   Params:   ids=<gtfsId1,gtfsId2,...>  (COMMA-SEPARATED, multiple platforms)
             total=N
             minutesAfter=120
             skip=atStop
             airCondition=true
   âš ï¸ Trailing slash IS required
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadDep(stopIds, stopName) {
  if (!apiKey) { showErr('edep', 'Zadejte API klÃ­Ä v postrannÃ­m panelu.'); return; }
  curId = stopIds; curName = stopName;
  document.getElementById('sdrop').style.display = 'none';
  document.getElementById('q').value = stopName;
  hideErr('edep');
  stopTmr();
  setBoard(`<div class="stb"><div class="spin"></div><div class="stt">NaÄÃ­tÃ¡m odjezdyâ€¦</div></div>`);

  const total = parseInt(gcfg('l', 10));
  const skip  = gcfg('sk', true)  ? '&skip=atStop' : '';
  const ac    = gcfg('ac', true)  ? '&airCondition=true' : '';

  // Build ids param â€” pass all gtfsIds for this stop (all platforms)
  const idsParam = stopIds.split(',').map(id => `ids=${encodeURIComponent(id.trim())}`).join('&');

  try {
    const url  = `${DEP_URL}?${idsParam}&total=${total}&minutesAfter=120${skip}${ac}`;
    const data = await goFetch(url);
    renderBoard(data, stopIds, stopName);
    startTmr(stopIds, stopName);
  } catch(err) {
    showErr('edep', 'Chyba naÄÃ­tÃ¡nÃ­: ' + err.message);
    setBoard(`<div class="stb"><div class="sti">âš ï¸</div><div class="stt">Chyba</div><div class="std">${esc2(err.message)}</div></div>`);
  }
}

function renderBoard(data, stopIds, stopName) {
  const deps    = data.departures || [];
  const isSaved = saved.some(s => s.id === stopIds);
  const tm      = gcfg('tm', 'm');

  setBoard(`
    <div class="bh">
      <div>
        <div class="bt">ğŸ“ ${esc2(stopName)}</div>
        <div class="bs">${stopIds.split(',')[0]} Â· ${deps.length} odjezdÅ¯ Â· ${new Date().toLocaleTimeString('cs-CZ')}</div>
      </div>
      <div class="ba">
        <button class="icb" id="starBtn"
          onclick="togSave('${esc(stopIds)}','${esc(stopName)}')"
          title="${isSaved ? 'Odebrat z oblÃ­benÃ½ch' : 'PÅ™idat do oblÃ­benÃ½ch'}"
        >${isSaved ? 'â­' : 'â˜†'}</button>
        <button class="icb" onclick="loadDep('${esc(stopIds)}','${esc(stopName)}')" title="Obnovit">âŸ³</button>
      </div>
    </div>

    <div class="rb2">
      <span class="rl">âŸ³ Za <span id="rcd">${gcfg('r', 30)}</span>s</span>
      <div class="rp"><div class="rf" id="rfill" style="width:100%"></div></div>
      <span class="rl" style="color:var(--tx3)">${new Date().toLocaleTimeString('cs-CZ')}</span>
    </div>

    <div class="ftabs">
      <button class="ft on" onclick="fDep('all',this)">ğŸ”¢ VÅ¡e (${deps.length})</button>
      ${buildTabs(deps)}
    </div>

    ${deps.length === 0
      ? `<div class="stb"><div class="sti">ğŸ˜´</div><div class="stt">Å½Ã¡dnÃ© odjezdy</div><div class="std">V blÃ­zkÃ© dobÄ› nejsou plÃ¡novÃ¡ny Å¾Ã¡dnÃ© odjezdy.</div></div>`
      : `<table class="dt">
          <thead><tr>
            <th>Linka</th><th>SmÄ›r</th><th>ÄŒas</th>
            ${tm !== 't' ? '<th>Za</th>' : ''}
            <th>ZpoÅ¾dÄ›nÃ­</th><th>StÃ¡nÃ­</th>
          </tr></thead>
          <tbody>${deps.map((d, i) => depRow(d, i, tm)).join('')}</tbody>
        </table>`
    }`);
}

function depRow(d, i, tm) {
  const route = d.route || {};
  const trip  = d.trip  || {};
  const ts    = d.departure_timestamp || d.arrival_timestamp || {};
  const disp  = ts.predicted || ts.scheduled;
  const short = route.short_name || '?';
  const head  = trip.headsign || 'â€”';
  const rtype = rType(route.type, short);
  const rcls  = rCls(rtype, short);
  const tstr  = disp ? new Date(disp).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}) : '--:--';

  let minHtml = '';
  if (disp) {
    const diff = Math.round((new Date(disp) - Date.now()) / 60000);
    minHtml = diff <= 0 ? `<span class="mn now">NYNÃ</span>`
            : diff <= 2 ? `<span class="mn soon">${diff}'</span>`
            : diff <= 5 ? `<span class="mn near">${diff}'</span>`
            :              `<span class="mn ok">${diff}'</span>`;
  }

  const dsec = d.delay ?? ts.delay ?? null;
  let dlHtml = `<span class="dl" style="opacity:.3">â€”</span>`;
  if (dsec !== null) {
    const dm = Math.round(dsec / 60);
    dlHtml = dm > 1  ? `<span class="dl late">+${dm}min</span>`
           : dm < -1 ? `<span class="dl early">${dm}min</span>`
           :            `<span class="dl ok">Â±0</span>`;
  }

  const platform = d.stop?.platform_code || '';
  const acM = gcfg('ac', true) && d.vehicle_registration?.air_conditioned ? ' â„ï¸' : '';

  return `<tr class="dr" data-rt="${rtype.toLowerCase()}" style="animation-delay:${i*30}ms">
    <td><span class="rbl ${rcls}">${short}</span></td>
    <td>${esc2(head)}${acM}</td>
    <td><span style="font:700 12px/1 var(--M)">${tstr}</span></td>
    ${tm !== 't' ? `<td>${minHtml}</td>` : ''}
    <td>${dlHtml}</td>
    <td style="font:400 9px/1 var(--M);color:var(--tx3)">${platform}</td>
  </tr>`;
}

function buildTabs(deps) {
  const cnt = {};
  deps.forEach(d => { const t = rType(d.route?.type, d.route?.short_name); cnt[t] = (cnt[t]||0)+1; });
  return Object.entries(cnt).map(([t,c]) =>
    `<button class="ft" onclick="fDep('${t.toLowerCase()}',this)">${rIc(t)} ${t} (${c})</button>`
  ).join('');
}

function fDep(type, btn) {
  document.querySelectorAll('.ft').forEach(t => t.classList.remove('on'));
  btn.classList.add('on');
  document.querySelectorAll('.dr').forEach(r => {
    r.style.display = (type === 'all' || r.dataset.rt === type) ? '' : 'none';
  });
}

function setBoard(html) { document.getElementById('board').innerHTML = html; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTmr(ids, name) {
  stopTmr();
  const iv = parseInt(gcfg('r', 30));
  if (!iv) return;
  cd = iv;
  timer = setInterval(() => {
    cd--;
    const rcd  = document.getElementById('rcd');
    const fill = document.getElementById('rfill');
    if (rcd)  rcd.textContent = cd;
    if (fill) fill.style.width = (cd / iv * 100) + '%';
    if (cd <= 0) loadDep(ids, name);
  }, 1000);
}
function stopTmr() { if (timer) { clearInterval(timer); timer = null; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VEHICLES
   Endpoint: GET /v2/pid/vehiclepositions/   â† trailing slash
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadV() {
  if (!apiKey) { showErr('eveh', 'Zadejte API klÃ­Ä.'); return; }
  hideErr('eveh');
  document.getElementById('vb').innerHTML =
    `<div class="stb"><div class="spin"></div><div class="stt">NaÄÃ­tÃ¡m vozidlaâ€¦</div></div>`;
  try {
    const data = await goFetch(`${VEH_URL}?limit=50&includeNotTracking=false`);
    allVeh = data.features || [];
    filtV();
  } catch(err) {
    showErr('eveh', 'Chyba: ' + err.message);
    document.getElementById('vb').innerHTML =
      `<div class="stb"><div class="sti">âš ï¸</div><div class="stt">Chyba</div><div class="std">${esc2(err.message)}</div></div>`;
  }
}

function filtV() {
  const q = (document.getElementById('vq').value || '').trim().toUpperCase();
  const list = q ? allVeh.filter(v => (v.properties?.route?.short_name||'').toUpperCase().includes(q)) : allVeh;
  if (!list.length) {
    document.getElementById('vb').innerHTML =
      `<div class="stb"><div class="sti">ğŸšŒ</div><div class="stt">Å½Ã¡dnÃ¡ vozidla</div></div>`;
    return;
  }
  const cards = list.map((v, i) => {
    const p     = v.properties || {};
    const short = p.route?.short_name || '?';
    const rtype = rType(p.route?.type, short);
    const rcls  = rCls(rtype, short);
    const head  = p.trip?.headsign || 'â€”';
    const delay = p.delay != null ? Math.round(p.delay / 60) : null;
    const dcls  = delay == null ? '' : delay > 1 ? 'late' : delay < -1 ? 'early' : 'ok2';
    const dtxt  = delay == null ? 'â€”' : delay > 0 ? `+${delay}min` : delay < 0 ? `${delay}min` : 'Â±0min';
    const spd   = p.speed   != null ? Math.round(p.speed) + ' km/h' : 'â€”';
    const bear  = p.bearing != null ? p.bearing + 'Â°' : 'â€”';
    const ac    = p.vehicle_registration?.air_conditioned;
    return `<div class="vc" style="animation-delay:${i*20}ms">
      <div class="vch">
        <div><span class="rbl ${rcls}">${rIc(rtype)} ${short}</span><div class="vhs" title="${esc2(head)}">${esc2(head)}</div></div>
        <div class="vdt"></div>
      </div>
      <div class="vm">
        <div class="vmi"><div class="vml">ZpoÅ¾dÄ›nÃ­</div><div class="vmv ${dcls}">${dtxt}</div></div>
        <div class="vmi"><div class="vml">Rychlost</div><div class="vmv">${spd}</div></div>
        <div class="vmi"><div class="vml">SmÄ›r</div><div class="vmv">${bear}</div></div>
        <div class="vmi"><div class="vml">Klima</div><div class="vmv">${ac ? 'â„ï¸ Ano' : ac === false ? 'Ne' : 'â€”'}</div></div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('vb').innerHTML =
    `<div style="font:400 9px/1 var(--M);color:var(--tx3);margin-bottom:10px">${list.length} vozidel Â· ${new Date().toLocaleTimeString('cs-CZ')}</div>
     <div class="vg">${cards}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVED STOPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togSave(id, name) {
  const idx = saved.findIndex(s => s.id === id);
  if (idx >= 0) saved.splice(idx, 1); else saved.push({ id, name });
  localStorage.setItem('pid.sv', JSON.stringify(saved));
  const btn = document.getElementById('starBtn');
  if (btn) btn.textContent = saved.some(s => s.id === id) ? 'â­' : 'â˜†';
  renderSaved();
}
function renderSaved() {
  const el = document.getElementById('savedList');
  if (!el) return;
  if (!saved.length) { el.innerHTML = '<div class="sem">Å½Ã¡dnÃ© oblÃ­benÃ©</div>'; return; }
  el.innerHTML = saved.map(s => `
    <div class="svi${curId === s.id ? ' cur' : ''}" onclick="loadDep('${esc(s.id)}','${esc(s.name)}')">
      <div><div class="sn">ğŸš ${esc2(s.name)}</div><div class="sid">${s.id.split(',')[0]}</div></div>
      <button class="srm" onclick="event.stopPropagation();rmSaved('${esc(s.id)}')">âœ•</button>
    </div>`).join('');
}
function rmSaved(id) { saved = saved.filter(s => s.id !== id); localStorage.setItem('pid.sv', JSON.stringify(saved)); renderSaved(); }
function clrSaved()  { saved = []; localStorage.removeItem('pid.sv'); renderSaved(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gcfg(k, def) { return cfg[k] != null ? cfg[k] : def; }
function sc(k, v)     { cfg[k] = v; localStorage.setItem('pid.cfg', JSON.stringify(cfg)); }
function st(k, el)    { const v = !el.classList.contains('on'); el.className = 'tog' + (v ? ' on' : ''); sc(k, v); }
function applyCfg() {
  const r  = document.getElementById('cfgR');  if (r)  r.value  = gcfg('r', 30);
  const l  = document.getElementById('cfgL');  if (l)  l.value  = gcfg('l', 10);
  const t  = document.getElementById('cfgT');  if (t)  t.value  = gcfg('tm', 'm');
  const sk = document.getElementById('tSkip'); if (sk) sk.className = 'tog' + (gcfg('sk', true) ? ' on' : '');
  const ac = document.getElementById('tAC');   if (ac) ac.className = 'tog' + (gcfg('ac', true) ? ' on' : '');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTE TYPE HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rType(n, short) {
  if (n===1||n===401) return 'Metro';
  if (n===0||n===900) return 'Tramvaj';
  if (n===2||n===100||n===102||n===106) return 'Vlak';
  if (n===4) return 'PÅ™Ã­voz';
  const s = (short || '').toString().toUpperCase();
  if (['A','B','C'].includes(s)) return 'Metro';
  if (/^[PN]\d/.test(s)) return 'NoÄnÃ­';
  return 'Bus';
}
function rCls(type, short) {
  if (type === 'Metro') {
    const s = (short || '').toUpperCase();
    return s==='A' ? 'rb-ma' : s==='B' ? 'rb-mb' : s==='C' ? 'rb-mc' : 'rb-mb';
  }
  if (type === 'Tramvaj') return 'rb-tram';
  if (type === 'Vlak')    return 'rb-train';
  if (type === 'PÅ™Ã­voz')  return 'rb-ferry';
  if (type === 'NoÄnÃ­')   return 'rb-night';
  return 'rb-bus';
}
function rIc(t) { return {Metro:'ğŸš‡',Tramvaj:'ğŸšƒ',Vlak:'ğŸš‚',PÅ™Ã­voz:'â›´',NoÄnÃ­:'ğŸŒ™',Bus:'ğŸšŒ'}[t] || 'ğŸšŒ'; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function goFetch(url) {
  if (!apiKey) throw new Error('API klÃ­Ä nenÃ­ nastaven â€” zadejte ho v postrannÃ­m panelu');
  const res = await fetch(url, { headers: { 'X-Access-Token': apiKey } });
  if (!res.ok) {
    let msg = `HTTP ${res.status}`;
    try { const j = await res.json(); msg = j.message || j.error || j.detail || msg; } catch(_) {}
    if (res.status === 401) msg = 'NeplatnÃ½ API klÃ­Ä (401) â€” zkontrolujte klÃ­Ä';
    if (res.status === 403) msg = 'PÅ™Ã­stup odepÅ™en (403)';
    if (res.status === 404) msg = 'Endpoint nenalezen (404) â€” kontaktujte autora';
    if (res.status === 429) msg = 'PÅ™Ã­liÅ¡ mnoho poÅ¾adavkÅ¯ (429) â€” zkuste za chvÃ­li';
    throw new Error(msg);
  }
  return res.json();
}
function showErr(id, msg) { const el=document.getElementById(id); if(el){el.textContent='âš ï¸ '+msg; el.style.display='block';} }
function hideErr(id)      { const el=document.getElementById(id); if(el) el.style.display='none'; }
// HTML escape for display
function esc2(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
// JS string escape for onclick attrs
function esc(s)  { return String(s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
</script>
</body>
</html>
