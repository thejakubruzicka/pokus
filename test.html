<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PID Odjezdy ‚Äî Pra≈æsk√° integrovan√° doprava</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0c10;--bg2:#111318;--bg3:#1a1d24;--border:#252932;
  --text:#e8eaf0;--text2:#8a8f9e;--text3:#545966;
  --accent:#f5c842;--accent2:#ff6b35;--accent3:#4ea8ff;
  --green:#44d986;--red:#ff4f4f;--orange:#ff9f40;
  --metro-a:#00a562;--metro-b:#f5c842;--metro-c:#c8102e;
  --radius:10px;--font-mono:'Space Mono',monospace;--font-sans:'DM Sans',sans-serif;--tr:.2s ease;
}
[data-theme="light"]{--bg:#f4f1eb;--bg2:#fff;--bg3:#ece9e0;--border:#d8d3c8;--text:#1a1a1a;--text2:#5a5a6a;--text3:#9a9aaa;--accent:#d4a000;--accent2:#e05020;--accent3:#0060cc}
[data-theme="tram"]{--bg:#0d1a0f;--bg2:#112014;--bg3:#162b1a;--border:#1e3524;--text:#d6f5dc;--text2:#6db87a;--text3:#3a6644;--accent:#44d986;--accent2:#a8ff78;--accent3:#78ffd6}
[data-theme="metro"]{--bg:#04060f;--bg2:#080c1e;--bg3:#0d1330;--border:#151e40;--text:#c8d8ff;--text2:#6878aa;--text3:#384060;--accent:#4ea8ff;--accent2:#a060ff;--accent3:#ff60a0}
[data-theme="terminal"]{--bg:#000;--bg2:#050505;--bg3:#0a0a0a;--border:#1a1a1a;--text:#00ff41;--text2:#007a1e;--text3:#004010;--accent:#00ff41;--accent2:#00cc33;--accent3:#00aa28}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--font-sans);min-height:100vh;transition:background var(--tr),color var(--tr)}
.layout{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
header{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:36px;height:36px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-weight:700;font-size:14px;color:#000;flex-shrink:0}
.logo-text{font-family:var(--font-mono);font-weight:700;font-size:15px;letter-spacing:.02em}
.logo-sub{font-size:10px;color:var(--text3);font-family:var(--font-mono);letter-spacing:.08em;text-transform:uppercase}
.header-right{display:flex;align-items:center;gap:12px}
.live-badge{display:flex;align-items:center;gap:6px;background:rgba(68,217,134,.1);border:1px solid rgba(68,217,134,.25);border-radius:20px;padding:4px 10px;font-size:11px;font-family:var(--font-mono);color:var(--green)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s ease infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.clock{font-family:var(--font-mono);font-size:14px;color:var(--text2)}
.theme-picker{display:flex;align-items:center;gap:4px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:4px}
.theme-btn{width:22px;height:22px;border-radius:5px;border:2px solid transparent;cursor:pointer;transition:transform .15s,border-color .15s;position:relative}
.theme-btn:hover{transform:scale(1.2)}.theme-btn.active{border-color:var(--accent)}
.theme-btn[data-theme="dark"]{background:#111318}.theme-btn[data-theme="light"]{background:#f4f1eb}
.theme-btn[data-theme="tram"]{background:#112014}.theme-btn[data-theme="metro"]{background:#080c1e}.theme-btn[data-theme="terminal"]{background:#000}
.theme-btn-label{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:3px 7px;font-size:10px;font-family:var(--font-mono);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s}
.theme-btn:hover .theme-btn-label{opacity:1}
.sidebar{background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;padding:20px 0}
.nav-section{padding:0 16px;margin-bottom:24px}
.nav-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);font-family:var(--font-mono);padding:0 8px;margin-bottom:8px}
.nav-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;border:none;background:transparent;color:var(--text2);cursor:pointer;font-family:var(--font-sans);font-size:14px;font-weight:500;transition:background var(--tr),color var(--tr);text-align:left;margin-bottom:2px}
.nav-btn:hover{background:var(--bg3);color:var(--text)}.nav-btn.active{background:rgba(245,200,66,.1);color:var(--accent)}
.nav-btn .ni{font-size:16px;width:20px;text-align:center}
.api-section{padding:0 16px;margin-bottom:24px}
.api-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);font-family:var(--font-mono);margin-bottom:8px;padding:0 8px}
.api-input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;color:var(--text);font-family:var(--font-mono);font-size:11px;outline:none;transition:border-color var(--tr)}
.api-input:focus{border-color:var(--accent)}.api-input::placeholder{color:var(--text3)}
.api-save-btn{width:100%;margin-top:6px;padding:7px;background:var(--accent);color:#000;border:none;border-radius:6px;font-family:var(--font-mono);font-size:11px;font-weight:700;cursor:pointer;transition:opacity var(--tr)}
.api-save-btn:hover{opacity:.85}
.api-status{font-size:10px;font-family:var(--font-mono);margin-top:5px;padding:0 2px}
.api-status.ok{color:var(--green)}.api-status.err{color:var(--red)}
.saved-stop{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background var(--tr);margin-bottom:2px}
.saved-stop:hover{background:var(--bg3)}.saved-stop.active{background:rgba(245,200,66,.08)}
.saved-stop-name{font-size:13px;font-weight:500;color:var(--text)}
.saved-stop-id{font-size:10px;font-family:var(--font-mono);color:var(--text3)}
.saved-stop-remove{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 4px;border-radius:4px;transition:color var(--tr),background var(--tr)}
.saved-stop-remove:hover{color:var(--red);background:rgba(255,79,79,.08)}
.empty-state{padding:8px 12px;font-size:12px;color:var(--text3);font-style:italic}
.main{overflow-y:auto;padding:24px;background:var(--bg)}
.page{display:none}.page.active{display:block}
.quick-picks{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
.qp-label{font-size:11px;font-family:var(--font-mono);color:var(--text3)}
.qp-btn{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all var(--tr)}
.qp-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(245,200,66,.06)}
.search-bar{display:flex;gap:10px;margin-bottom:16px}
.search-input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-family:var(--font-sans);font-size:14px;outline:none;transition:border-color var(--tr)}
.search-input:focus{border-color:var(--accent)}.search-input::placeholder{color:var(--text3)}
.search-btn{padding:12px 20px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);font-family:var(--font-mono);font-size:13px;font-weight:700;cursor:pointer;letter-spacing:.04em;transition:opacity var(--tr),transform .1s;white-space:nowrap}
.search-btn:hover{opacity:.85}.search-btn:active{transform:scale(.97)}
.search-results{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px;display:none}
.search-result-item{padding:11px 16px;cursor:pointer;transition:background var(--tr);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.search-result-item:last-child{border-bottom:none}.search-result-item:hover{background:var(--bg3)}
.result-name{font-size:14px;font-weight:500}.result-meta{font-size:11px;font-family:var(--font-mono);color:var(--text3)}
.board-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
.board-title{font-family:var(--font-mono);font-size:22px;font-weight:700;letter-spacing:-.02em;line-height:1.2}
.board-sub{font-size:12px;color:var(--text3);font-family:var(--font-mono);margin-top:4px}
.board-actions{display:flex;gap:8px}
.icon-btn{width:36px;height:36px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--text2);transition:background var(--tr),color var(--tr),border-color var(--tr)}
.icon-btn:hover{background:var(--bg3);color:var(--text);border-color:var(--accent)}
.filter-tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.filter-tab{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font-size:12px;font-family:var(--font-mono);cursor:pointer;transition:all var(--tr)}
.filter-tab:hover{border-color:var(--accent);color:var(--text)}.filter-tab.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.departures-table{width:100%;border-collapse:collapse;font-size:14px}
.departures-table thead tr{border-bottom:1px solid var(--border)}
.departures-table th{text-align:left;padding:8px 12px;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);font-family:var(--font-mono);font-weight:400}
.dep-row{border-bottom:1px solid var(--border);transition:background var(--tr);animation:slideIn .3s ease forwards;opacity:0}
.dep-row:hover{background:var(--bg2)}
@keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.dep-row td{padding:11px 12px;vertical-align:middle}
.route-badge{display:inline-flex;align-items:center;justify-content:center;min-width:40px;padding:3px 8px;border-radius:6px;font-family:var(--font-mono);font-weight:700;font-size:13px}
.rb-bus{background:rgba(78,168,255,.15);color:var(--accent3)}
.rb-tram{background:rgba(255,107,53,.15);color:var(--accent2)}
.rb-ma{background:rgba(0,165,98,.2);color:var(--metro-a)}
.rb-mb{background:rgba(245,200,66,.2);color:var(--metro-b)}
.rb-mc{background:rgba(200,16,46,.2);color:var(--metro-c)}
.rb-night{background:rgba(138,143,158,.15);color:var(--text2)}
.rb-train{background:rgba(180,100,255,.15);color:#b464ff}
.rb-ferry{background:rgba(0,200,255,.15);color:#00c8ff}
.dep-time{font-family:var(--font-mono);font-size:14px;font-weight:700}
.dtm{display:inline-block;font-family:var(--font-mono);font-weight:700;font-size:13px;padding:3px 8px;border-radius:5px}
.dtm.soon{background:rgba(255,79,79,.15);color:var(--red)}
.dtm.near{background:rgba(255,159,64,.15);color:var(--orange)}
.dtm.ok{background:rgba(68,217,134,.12);color:var(--green)}
.dtm.now{background:var(--accent);color:#000;animation:fn 1s ease infinite}
@keyframes fn{0%,100%{opacity:1}50%{opacity:.6}}
.dep-headsign{font-weight:500}
.dep-delay{font-size:11px;font-family:var(--font-mono)}
.dep-delay.late{color:var(--red)}.dep-delay.early{color:var(--green)}.dep-delay.ot{color:var(--green)}
.dep-platform{font-size:11px;font-family:var(--font-mono);color:var(--text3)}
.state-box{padding:60px 24px;text-align:center;color:var(--text3)}
.state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
.state-title{font-size:18px;font-family:var(--font-mono);color:var(--text2);margin-bottom:8px}
.state-desc{font-size:13px;line-height:1.7;max-width:420px;margin:0 auto}
.state-desc a{color:var(--accent3)}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.rbar{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.rbar-label{font-size:11px;font-family:var(--font-mono);color:var(--text2);white-space:nowrap}
.rbar-progress{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.rbar-fill{height:100%;background:var(--accent);transition:width 1s linear;border-radius:2px}
.vehicle-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-top:20px}
.vehicle-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color var(--tr),transform .15s;animation:slideIn .3s ease forwards;opacity:0}
.vehicle-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.vc-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.vc-heading{font-size:15px;font-weight:700;color:var(--text);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.vc-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s ease infinite;margin-top:4px}
.vc-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;font-family:var(--font-mono)}
.vc-mi{background:var(--bg3);border-radius:6px;padding:6px 8px}
.vc-ml{color:var(--text3);margin-bottom:2px}.vc-mv{color:var(--text);font-weight:700}
.vc-mv.late{color:var(--red)}.vc-mv.early{color:var(--accent3)}.vc-mv.ot{color:var(--green)}
.ac{max-width:700px}
.ah{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:32px;margin-bottom:20px;position:relative;overflow:hidden}
.ah::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(245,200,66,.08) 0%,transparent 70%);pointer-events:none}
.ah-title{font-family:var(--font-mono);font-size:28px;font-weight:700;letter-spacing:-.03em;margin-bottom:8px}
.ah-title span{color:var(--accent)}
.ah-desc{font-size:14px;line-height:1.7;color:var(--text2);max-width:500px}
.as{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px}
.as-title{font-family:var(--font-mono);font-size:13px;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.as-title::after{content:'';flex:1;height:1px;background:var(--border)}
.fl{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fi{display:flex;align-items:flex-start;gap:10px;padding:10px;background:var(--bg3);border-radius:8px}
.fi-icon{font-size:18px;margin-top:1px}
.fi-text h4{font-size:13px;font-weight:700;margin-bottom:2px}.fi-text p{font-size:11px;color:var(--text2);line-height:1.4}
.cl-item{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid var(--border)}
.cl-item:last-child{border-bottom:none}
.cl-v{font-family:var(--font-mono);font-size:12px;font-weight:700;color:var(--accent);white-space:nowrap;min-width:55px}
.cl-d{font-family:var(--font-mono);font-size:11px;color:var(--text3);margin-top:2px}
.cl-e h4{font-size:13px;font-weight:700;margin-bottom:4px}
.cl-e ul{padding-left:16px}.cl-e li{font-size:12px;color:var(--text2);margin-bottom:2px;line-height:1.5}
.tag{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-family:var(--font-mono);font-weight:700;letter-spacing:.05em;margin-right:4px}
.tag-new{background:rgba(68,217,134,.15);color:var(--green)}.tag-fix{background:rgba(255,79,79,.15);color:var(--red)}.tag-imp{background:rgba(78,168,255,.15);color:var(--accent3)}
.lbtn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-family:var(--font-mono);font-size:12px;color:var(--text2);text-decoration:none;transition:border-color var(--tr),color var(--tr)}
.lbtn:hover{border-color:var(--accent);color:var(--accent)}
.sg{display:grid;gap:12px}
.sr{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:8px}
.sl h4{font-size:13px;font-weight:500}.sl p{font-size:11px;color:var(--text3);margin-top:2px}
.toggle{width:40px;height:22px;background:var(--border);border-radius:11px;position:relative;cursor:pointer;transition:background var(--tr);flex-shrink:0}
.toggle.on{background:var(--accent)}.toggle::after{content:'';position:absolute;width:18px;height:18px;background:white;border-radius:50%;top:2px;left:2px;transition:left var(--tr)}.toggle.on::after{left:20px}
select.ss{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none;cursor:pointer}
.page-title{font-family:var(--font-mono);font-size:20px;font-weight:700;margin-bottom:6px;letter-spacing:-.02em}
.page-subtitle{font-size:13px;color:var(--text3);margin-bottom:24px}
.err{background:rgba(255,79,79,.1);border:1px solid rgba(255,79,79,.3);border-radius:8px;padding:12px 16px;font-size:13px;color:var(--red);margin-bottom:16px;display:none;line-height:1.5;white-space:pre-line}
.inf{background:rgba(78,168,255,.1);border:1px solid rgba(78,168,255,.25);border-radius:8px;padding:12px 16px;font-size:13px;color:var(--accent3);margin-bottom:16px;line-height:1.5}
.code-block{font-family:var(--font-mono);font-size:11px;color:var(--text2);background:var(--bg3);border-radius:8px;padding:14px;line-height:2}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--text3)}
@media(max-width:768px){.layout{grid-template-columns:1fr;grid-template-rows:auto auto 1fr}.sidebar{border-right:none;border-bottom:1px solid var(--border);padding:12px 0;display:flex;overflow-x:auto}.nav-section{margin-bottom:0;display:flex;gap:4px}.nav-label,.api-section,.saved-stops-section{display:none}.nav-btn{width:auto;white-space:nowrap}.fl{grid-template-columns:1fr}.header-right .clock{display:none}}
</style>
</head>
<body data-theme="dark">
<div class="layout">

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">PID</div>
    <div>
      <div class="logo-text">Odjezdov√° tabule</div>
      <div class="logo-sub">CIS ¬∑ Golemio API v2</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div><span>≈ΩIVƒö</span></div>
    <div class="clock" id="clock">--:--:--</div>
    <div class="theme-picker">
      <button class="theme-btn active" data-theme="dark" onclick="setTheme('dark')"><span class="theme-btn-label">Noƒçn√≠</span></button>
      <button class="theme-btn" data-theme="light" onclick="setTheme('light')"><span class="theme-btn-label">Denn√≠</span></button>
      <button class="theme-btn" data-theme="tram" onclick="setTheme('tram')"><span class="theme-btn-label">Tramvaj</span></button>
      <button class="theme-btn" data-theme="metro" onclick="setTheme('metro')"><span class="theme-btn-label">Metro</span></button>
      <button class="theme-btn" data-theme="terminal" onclick="setTheme('terminal')"><span class="theme-btn-label">Termin√°l</span></button>
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="nav-section">
    <div class="nav-label">Navigace</div>
    <button class="nav-btn active" onclick="showPage('departures')"><span class="ni">üöè</span> Odjezdy</button>
    <button class="nav-btn" onclick="showPage('vehicles')"><span class="ni">üöå</span> Vozidla</button>
    <button class="nav-btn" onclick="showPage('settings')"><span class="ni">‚öôÔ∏è</span> Nastaven√≠</button>
    <button class="nav-btn" onclick="showPage('about')"><span class="ni">‚ÑπÔ∏è</span> O aplikaci</button>
  </div>
  <div class="api-section">
    <div class="api-label">Golemio API kl√≠ƒç</div>
    <input class="api-input" type="password" id="apiKeyInput" placeholder="Vlo≈æte API kl√≠ƒç‚Ä¶" autocomplete="off">
    <button class="api-save-btn" onclick="saveApiKey()">üíæ Ulo≈æit kl√≠ƒç</button>
    <div class="api-status" id="apiStatus"></div>
    <div style="margin-top:8px;font-size:10px;color:var(--text3);padding:0 2px;font-family:var(--font-mono);">
      Bezplatn√° registrace:<br>
      <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--accent3);text-decoration:none;">api.golemio.cz ‚Üí</a>
    </div>
  </div>
  <div class="nav-section" id="savedStopsSection">
    <div class="nav-label">Ulo≈æen√© zast√°vky</div>
    <div id="savedStopsList"></div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- DEPARTURES -->
  <div class="page active" id="page-departures">
    <div class="quick-picks">
      <span class="qp-label">Rychl√Ω v√Ωbƒõr:</span>
      <button class="qp-btn" onclick="loadDepartures('U539Z1P','N√°rodn√≠ t≈ô√≠da')">N√°rodn√≠ t≈ô√≠da</button>
      <button class="qp-btn" onclick="loadDepartures('U118Z1P','Hlavn√≠ n√°dra≈æ√≠')">Hlavn√≠ n√°dra≈æ√≠</button>
      <button class="qp-btn" onclick="loadDepartures('U953Z1P','V√°clavsk√© n√°m.')">V√°clavsk√© n√°m.</button>
      <button class="qp-btn" onclick="loadDepartures('U100Z1P','M≈Østek')">M≈Østek</button>
      <button class="qp-btn" onclick="loadDepartures('U307Z1P','Andƒõl')">Andƒõl</button>
      <button class="qp-btn" onclick="loadDepartures('U5462Z1P','Leti≈°tƒõ T1')">Leti≈°tƒõ T1</button>
    </div>
    <div class="search-bar">
      <input class="search-input" id="stopSearch" type="text"
             placeholder="Hledat zast√°vku (nap≈ô. N√°mƒõst√≠ M√≠ru, Florenc)‚Ä¶"
             oninput="onStopInput()" onkeydown="if(event.key==='Enter')searchStops()">
      <button class="search-btn" onclick="searchStops()">üîç Hledat</button>
    </div>
    <div class="search-results" id="searchResults"></div>
    <div class="err" id="errorBanner"></div>
    <div id="boardContainer">
      <div class="state-box">
        <div class="state-icon">üöè</div>
        <div class="state-title">Vyberte zast√°vku</div>
        <div class="state-desc">
          Kliknƒõte na zast√°vku v rychl√©m v√Ωbƒõru v√Ω≈°e, nebo zadejte n√°zev do vyhled√°vac√≠ho pole.<br><br>
          Pro ≈æiv√° data vlo≈æte v√°≈° Golemio API kl√≠ƒç do postrann√≠ho panelu.<br>
          <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank">Z√≠skat kl√≠ƒç zdarma ‚Üí</a>
        </div>
      </div>
    </div>
  </div>

  <!-- VEHICLES -->
  <div class="page" id="page-vehicles">
    <div class="page-title">üöå Vozidla v provozu</div>
    <div class="page-subtitle">Aktu√°ln√≠ polohy vozidel PID (vy≈æaduje API kl√≠ƒç)</div>
    <div class="search-bar">
      <input class="search-input" id="vehicleSearch" type="text"
             placeholder="Filtrovat podle ƒç√≠sla linky (22, A, 178, S1)‚Ä¶"
             oninput="filterVehicles()">
      <button class="search-btn" onclick="loadVehicles()">‚ü≥ Naƒç√≠st vozidla</button>
    </div>
    <div class="err" id="vehicleError"></div>
    <div id="vehicleContainer">
      <div class="state-box">
        <div class="state-icon">üó∫Ô∏è</div>
        <div class="state-title">Naƒçtƒõte vozidla</div>
        <div class="state-desc">Stisknƒõte ‚ÄûNaƒç√≠st vozidla" pro zobrazen√≠ aktu√°ln√≠ch poloh.</div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div class="page-title">‚öôÔ∏è Nastaven√≠</div>
    <div class="page-subtitle">P≈ôizp≈Øsobte si zobrazen√≠ a chov√°n√≠ aplikace</div>
    <div class="as">
      <div class="as-title">Odjezdov√° tabule</div>
      <div class="sg">
        <div class="sr"><div class="sl"><h4>Auto-obnoven√≠</h4><p>Jak ƒçasto se data obnov√≠</p></div>
          <select class="ss" id="refreshInterval" onchange="updateRefreshInterval()">
            <option value="20">20s</option><option value="30" selected>30s</option>
            <option value="45">45s</option><option value="60">60s</option><option value="0">Vypnout</option>
          </select></div>
        <div class="sr"><div class="sl"><h4>Limit odjezd≈Ø</h4><p>Poƒçet zobrazen√Ωch ≈ô√°dk≈Ø</p></div>
          <select class="ss" id="departureLimit" onchange="saveSetting('departureLimit',this.value)">
            <option value="5">5</option><option value="10" selected>10</option>
            <option value="15">15</option><option value="20">20</option>
          </select></div>
        <div class="sr"><div class="sl"><h4>P≈ôeskoƒçit vozidla v zast√°vce</h4><p>Nezobrazovat vozidla pr√°vƒõ stoj√≠c√≠ v zast√°vce</p></div>
          <div class="toggle on" id="togSkip" onclick="toggleSetting('skipAtStop',this)"></div></div>
        <div class="sr"><div class="sl"><h4>Klimatizace ‚ùÑÔ∏è</h4><p>Zobrazit indik√°tor klimatizace</p></div>
          <div class="toggle on" id="togAC" onclick="toggleSetting('showAC',this)"></div></div>
        <div class="sr"><div class="sl"><h4>Zobrazen√≠ ƒçasu</h4><p>Minuty zb√Ωvaj√≠c√≠ / ƒças odjezdu / oboj√≠</p></div>
          <select class="ss" id="timeDisplay" onchange="saveSetting('timeDisplay',this.value)">
            <option value="minutes" selected>Minuty</option>
            <option value="time">ƒåas odjezdu</option>
            <option value="both">Oboj√≠</option>
          </select></div>
      </div>
    </div>
    <div class="as">
      <div class="as-title">Barevn√© t√©ma</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;padding:4px 0">
        <button onclick="setTheme('dark')" class="search-btn" style="padding:8px 14px;font-size:12px;">üåô Noƒçn√≠</button>
        <button onclick="setTheme('light')" class="search-btn" style="padding:8px 14px;font-size:12px;background:var(--bg3);color:var(--text);">‚òÄÔ∏è Denn√≠</button>
        <button onclick="setTheme('tram')" class="search-btn" style="padding:8px 14px;font-size:12px;background:rgba(68,217,134,.2);color:var(--green);">üöÉ Tramvaj</button>
        <button onclick="setTheme('metro')" class="search-btn" style="padding:8px 14px;font-size:12px;background:rgba(78,168,255,.2);color:var(--accent3);">üöá Metro</button>
        <button onclick="setTheme('terminal')" class="search-btn" style="padding:8px 14px;font-size:12px;background:#000;color:#00ff41;">üíª Termin√°l</button>
      </div>
    </div>
    <div class="as">
      <div class="as-title">Spr√°va dat</div>
      <div class="sg">
        <div class="sr"><div class="sl"><h4>Smazat obl√≠ben√© zast√°vky</h4><p>Odstran√≠ v≈°echny ulo≈æen√© zast√°vky</p></div>
          <button onclick="clearSavedStops()" class="search-btn" style="padding:7px 14px;background:rgba(255,79,79,.15);color:var(--red);border:1px solid rgba(255,79,79,.3);">Smazat</button></div>
        <div class="sr"><div class="sl"><h4>Smazat API kl√≠ƒç</h4><p>Odstran√≠ kl√≠ƒç z localStorage prohl√≠≈æeƒçe</p></div>
          <button onclick="clearApiKey()" class="search-btn" style="padding:7px 14px;background:rgba(255,79,79,.15);color:var(--red);border:1px solid rgba(255,79,79,.3);">Smazat</button></div>
      </div>
    </div>
  </div>

  <!-- ABOUT -->
  <div class="page" id="page-about">
    <div class="ac">
      <div class="ah">
        <div class="ah-title">PID <span>Odjezdov√°</span><br>Tabule</div>
        <div class="ah-desc">
          Neofici√°ln√≠ webov√° aplikace pro ≈æiv√© odjezdy Pra≈æsk√© integrovan√© dopravy.
          Data jsou poskytov√°na p≈ôes <strong>Golemio API v2</strong> (Oper√°tor ICT, a.s.)
          a syst√©m <strong>CIS</strong> ‚Äî Celost√°tn√≠ informaƒçn√≠ syst√©m o j√≠zdn√≠ch ≈ô√°dech.
        </div>
        <div style="margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;">
          <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" class="lbtn">üîë Z√≠skat API kl√≠ƒç</a>
          <a href="https://api.golemio.cz/v2/pid/docs/openapi/" target="_blank" class="lbtn">üìñ Dokumentace API</a>
          <a href="https://pid.cz" target="_blank" class="lbtn">üöè pid.cz</a>
        </div>
      </div>

      <div class="as">
        <div class="as-title">Jak zaƒç√≠t</div>
        <div style="font-size:13px;line-height:1.9;color:var(--text2);">
          <strong style="color:var(--text)">1.</strong> Zaregistrujte se zdarma na <a href="https://api.golemio.cz/api-keys/auth/sign-up" target="_blank" style="color:var(--accent3)">api.golemio.cz</a> a ovƒõ≈ôte e-mail.<br>
          <strong style="color:var(--text)">2.</strong> Vygenerujte API kl√≠ƒç a vlo≈æte ho do postrann√≠ho panelu ‚Üí <em>Ulo≈æit kl√≠ƒç</em>.<br>
          <strong style="color:var(--text)">3.</strong> Na str√°nce Odjezdy kliknƒõte na tlaƒç√≠tko rychl√©ho v√Ωbƒõru nebo vyhledejte zast√°vku.<br>
          <strong style="color:var(--text)">4.</strong> Kliknut√≠m na ‚≠ê ulo≈æte zast√°vku do obl√≠ben√Ωch pro rychl√Ω p≈ô√≠stup.<br>
          <strong style="color:var(--text)">5.</strong> V Nastaven√≠ si p≈ôizp≈Øsobte t√©ma, interval obnovy a zobrazen√≠.
        </div>
      </div>

      <div class="as">
        <div class="as-title">Pou≈æit√© API endpointy</div>
        <div class="code-block">
          <div><span style="color:var(--green)">GET</span> <span style="color:var(--accent3)">https://api.golemio.cz/v2/pid/departureboards</span></div>
          <div style="color:var(--text3);padding-left:16px">?aswIds=U539Z1P&amp;limit=10&amp;minutesAfter=120&amp;skip=atStop</div>
          <br>
          <div><span style="color:var(--green)">GET</span> <span style="color:var(--accent3)">https://api.golemio.cz/v2/gtfs/stops</span></div>
          <div style="color:var(--text3);padding-left:16px">?names[]=N√°rodn√≠+t≈ô√≠da&amp;limit=10</div>
          <br>
          <div><span style="color:var(--green)">GET</span> <span style="color:var(--accent3)">https://api.golemio.cz/v2/vehiclepositions</span></div>
          <div style="color:var(--text3);padding-left:16px">?limit=50</div>
        </div>
      </div>

      <div class="as">
        <div class="as-title">Funkce aplikace</div>
        <div class="fl">
          <div class="fi"><div class="fi-icon">üöè</div><div class="fi-text"><h4>≈Ωiv√© odjezdy</h4><p>Re√°ln√° data z Golemio API, auto-obnoven√≠</p></div></div>
          <div class="fi"><div class="fi-icon">üîç</div><div class="fi-text"><h4>Vyhled√°v√°n√≠ zast√°vek</h4><p>Fulltextov√© hled√°n√≠ p≈ôes GTFS datab√°zi</p></div></div>
          <div class="fi"><div class="fi-icon">‚ö°</div><div class="fi-text"><h4>Rychl√Ω v√Ωbƒõr</h4><p>P≈ô√≠m√° tlaƒç√≠tka pro hlavn√≠ pra≈æsk√© uzly</p></div></div>
          <div class="fi"><div class="fi-icon">‚≠ê</div><div class="fi-text"><h4>Obl√≠ben√© zast√°vky</h4><p>Ulo≈æen√≠ zast√°vek v postrann√≠m panelu</p></div></div>
          <div class="fi"><div class="fi-icon">üöå</div><div class="fi-text"><h4>P≈ôehled vozidel</h4><p>Aktu√°ln√≠ polohy, zpo≈ædƒõn√≠, rychlost</p></div></div>
          <div class="fi"><div class="fi-icon">üé®</div><div class="fi-text"><h4>5 barevn√Ωch t√©mat</h4><p>Noƒçn√≠, Denn√≠, Tramvaj, Metro, Termin√°l</p></div></div>
        </div>
      </div>

      <div class="as">
        <div class="as-title">Changelog</div>
        <div class="cl-item">
          <div><div class="cl-v">v2.1</div><div class="cl-d">Feb 2026</div></div>
          <div class="cl-e">
            <h4><span class="tag tag-fix">OPRAVA</span>Spr√°vn√© API endpointy</h4>
            <ul>
              <li>Opraveny URL: /v2/pid/departureboards, /v2/gtfs/stops, /v2/vehiclepositions</li>
              <li>P≈ôid√°na tlaƒç√≠tka rychl√©ho v√Ωbƒõru (N√°rodn√≠ t≈ô√≠da, Hlavn√≠ n√°dra≈æ√≠, atd.)</li>
              <li>Vylep≈°en√© chybov√© zpr√°vy s plnou URL pro ladƒõn√≠</li>
              <li>Zobrazen√≠ skuteƒçn√Ωch API endpoint≈Ø v sekci O aplikaci</li>
            </ul>
          </div>
        </div>
        <div class="cl-item">
          <div><div class="cl-v">v2.0</div><div class="cl-d">Feb 2026</div></div>
          <div class="cl-e">
            <h4><span class="tag tag-new">NOV√â</span>Kompletn√≠ p≈ôepracov√°n√≠ UI</h4>
            <ul>
              <li>5 barevn√Ωch t√©mat, str√°nka Vozidla, pokroƒçil√° nastaven√≠</li>
              <li>Auto-obnoven√≠ s progress barem a odpoƒçtem</li>
              <li>Obl√≠ben√© zast√°vky, filtry dle typu dopravy</li>
            </ul>
          </div>
        </div>
        <div class="cl-item">
          <div><div class="cl-v">v1.0</div><div class="cl-d">Sep 2025</div></div>
          <div class="cl-e">
            <h4><span class="tag tag-new">NOV√â</span>Prvn√≠ vyd√°n√≠</h4>
            <ul>
              <li>Z√°kladn√≠ odjezdov√° tabule p≈ôes Golemio API</li>
              <li>Podpora MHD, tramvaj√≠, metra a vlak≈Ø PID</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="as">
        <div class="as-title">Pr√°vn√≠ informace</div>
        <div style="font-size:12px;color:var(--text3);line-height:1.7;font-family:var(--font-mono)">
          Data ¬© Oper√°tor ICT, a.s. ‚Äî Golemio API (CC BY 4.0)<br>
          Tato aplikace nen√≠ ofici√°ln√≠m produktem PID ani ROPID.<br>
          API kl√≠ƒç je ulo≈æen v√Ωhradnƒõ lok√°lnƒõ ve va≈°em prohl√≠≈æeƒçi.
        </div>
      </div>
    </div>
  </div>

</main>
</div>

<script>
// =====================
// CORRECT GOLEMIO v2 ENDPOINTS
// =====================
const EP_DEPARTURES = 'https://api.golemio.cz/v2/pid/departureboards';
const EP_STOPS      = 'https://api.golemio.cz/v2/gtfs/stops';
const EP_VEHICLES   = 'https://api.golemio.cz/v2/vehiclepositions';

// =====================
// STATE
// =====================
let apiKey = localStorage.getItem('pid_api_key') || '';
let curId = null, curName = '';
let rfTimer = null, rfCountdown = 30;
let rfInterval = parseInt(localStorage.getItem('pid_rf') || '30');
let allVehicles = [];
let savedStops = JSON.parse(localStorage.getItem('pid_stops') || '[]');
let cfg = JSON.parse(localStorage.getItem('pid_cfg') || '{}');

// =====================
// INIT
// =====================
addEventListener('load', () => {
  setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString('cs-CZ'), 1000);
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('cs-CZ');
  loadSettings();
  renderSaved();
  if (apiKey) { document.getElementById('apiKeyInput').value = apiKey; setApiStatus('ok','‚úì Kl√≠ƒç naƒçten'); }
  const t = localStorage.getItem('pid_theme'); if (t) setTheme(t);
});

// =====================
// THEME
// =====================
function setTheme(t) {
  document.body.dataset.theme = t;
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === t));
  localStorage.setItem('pid_theme', t);
}

// =====================
// NAV
// =====================
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  const map = { departures: 'odjezdy', vehicles: 'vozidla', settings: 'nastaven', about: 'o aplikaci' };
  document.querySelectorAll('.nav-btn').forEach(b => { if (b.textContent.toLowerCase().includes(map[p])) b.classList.add('active'); });
}

// =====================
// API KEY
// =====================
function saveApiKey() {
  const v = document.getElementById('apiKeyInput').value.trim();
  if (!v) { setApiStatus('err','‚úó Pr√°zdn√Ω kl√≠ƒç'); return; }
  apiKey = v; localStorage.setItem('pid_api_key', v); setApiStatus('ok','‚úì Kl√≠ƒç ulo≈æen');
}
function clearApiKey() {
  apiKey = ''; localStorage.removeItem('pid_api_key');
  document.getElementById('apiKeyInput').value = ''; setApiStatus('ok','‚úì Kl√≠ƒç smaz√°n');
}
function setApiStatus(cls, msg) {
  const el = document.getElementById('apiStatus'); el.textContent = msg; el.className = 'api-status ' + cls;
}

// =====================
// STOP SEARCH ‚Äî /v2/gtfs/stops?names[]=...
// =====================
let dbt = null;
function onStopInput() { clearTimeout(dbt); dbt = setTimeout(searchStops, 450); }

async function searchStops() {
  const q = document.getElementById('stopSearch').value.trim();
  const el = document.getElementById('searchResults');
  if (q.length < 2) { el.style.display = 'none'; return; }
  if (!apiKey) { showErr('Zadejte Golemio API kl√≠ƒç v postrann√≠m panelu.', 'errorBanner'); return; }
  hideErr('errorBanner');
  try {
    const url = `${EP_STOPS}?names[]=${encodeURIComponent(q)}&limit=10`;
    const r = await goFetch(url);
    const d = await r.json();
    renderStopResults(d.features || d.stops || []);
  } catch(e) { showErr('Chyba vyhled√°v√°n√≠: ' + e.message, 'errorBanner'); }
}

function renderStopResults(stops) {
  const el = document.getElementById('searchResults');
  if (!stops.length) {
    el.innerHTML = '<div class="search-result-item"><span class="result-name" style="color:var(--text3)">≈Ω√°dn√© v√Ωsledky ‚Äî zkuste jin√Ω n√°zev zast√°vky.</span></div>';
    el.style.display = 'block'; return;
  }
  el.innerHTML = stops.slice(0,8).map(s => {
    const p = s.properties || s;
    const name = p.stop_name || p.name || 'Nezn√°m√°';
    const id   = p.stop_id  || p.id  || '';
    const zone = p.zone_id  || '';
    const rt   = (p.route_type_name || '').toLowerCase();
    const icon = rt.includes('metro') ? 'üöá' : rt.includes('tram') ? 'üöÉ' : rt.includes('ferry') ? '‚õ¥' : 'üöå';
    return `<div class="search-result-item" onclick="loadDepartures('${id}','${esc(name)}')">
      <div><div class="result-name">${icon} ${name}</div>
      <div class="result-meta">ID: ${id}${zone?' ¬∑ Z√≥na '+zone:''}</div></div>
      <div style="font-size:12px;color:var(--text3)">‚Ä∫</div>
    </div>`;
  }).join('');
  el.style.display = 'block';
}

// =====================
// DEPARTURES ‚Äî /v2/pid/departureboards?aswIds=<id>&...
// =====================
async function loadDepartures(stopId, stopName) {
  curId = stopId; curName = stopName;
  document.getElementById('searchResults').style.display = 'none';
  document.getElementById('stopSearch').value = stopName;
  hideErr('errorBanner');
  clearRf();
  if (!apiKey) {
    showErr('Zadejte Golemio API kl√≠ƒç v postrann√≠m panelu, pot√© zkuste znovu.\nKl√≠ƒç zdarma na: api.golemio.cz/api-keys/auth/sign-up', 'errorBanner');
    return;
  }
  showLoading(stopName);
  const limit = getSetting('departureLimit', 10);
  const skip  = getSetting('skipAtStop', true) ? '&skip=atStop' : '';
  const ac    = getSetting('showAC', true) ? 'true' : 'false';
  const url   = `${EP_DEPARTURES}?aswIds=${encodeURIComponent(stopId)}&limit=${limit}&minutesAfter=120&airCondition=${ac}${skip}`;
  try {
    const r = await goFetch(url);
    if (!r.ok) {
      const eb = await r.json().catch(() => ({}));
      throw new Error(`HTTP ${r.status} ‚Äî ${eb.message || eb.error || 'Nezn√°m√° chyba'}`);
    }
    const d = await r.json();
    renderBoard(d, stopName, stopId);
    startRf(stopId, stopName);
    renderSaved();
  } catch(e) {
    clearBoard();
    showErr(`Chyba p≈ôi naƒç√≠t√°n√≠ odjezd≈Ø.\n${e.message}\n\nEndpoint: ${url}`, 'errorBanner');
  }
}

function renderBoard(data, stopName, stopId) {
  const deps    = data.departures || [];
  const isSaved = savedStops.some(s => s.id === stopId);
  const tm      = getSetting('timeDisplay', 'minutes');

  document.getElementById('boardContainer').innerHTML = `
    <div class="board-header">
      <div>
        <div class="board-title">üìç ${stopName}</div>
        <div class="board-sub">ID: ${stopId} ¬∑ ${deps.length} odjezd≈Ø ¬∑ ${new Date().toLocaleTimeString('cs-CZ')}</div>
      </div>
      <div class="board-actions">
        <button class="icon-btn" id="savBtn" title="${isSaved?'Odebrat':'Ulo≈æit'}" onclick="toggleSave('${stopId}','${esc(stopName)}')">${isSaved?'‚≠ê':'‚òÜ'}</button>
        <button class="icon-btn" title="Obnovit" onclick="loadDepartures('${stopId}','${esc(stopName)}')">‚ü≥</button>
      </div>
    </div>
    <div class="rbar">
      <span class="rbar-label">‚ü≥ Za <span id="rcd">${rfInterval}</span>s</span>
      <div class="rbar-progress"><div class="rbar-fill" id="rfill" style="width:100%"></div></div>
      <span class="rbar-label" style="color:var(--text3)">${new Date().toLocaleTimeString('cs-CZ')}</span>
    </div>
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="filterDeps('all',this)">üî¢ V≈°e (${deps.length})</button>
      ${buildTabs(deps)}
    </div>
    ${deps.length === 0
      ? '<div class="state-box"><div class="state-icon">üò¥</div><div class="state-title">≈Ω√°dn√© odjezdy</div><div class="state-desc">V bl√≠zk√© dobƒõ nejsou pl√°nov√°ny ≈æ√°dn√© odjezdy.</div></div>'
      : `<table class="departures-table">
           <thead><tr>
             <th>Linka</th><th>Smƒõr</th><th>ƒåas</th>
             ${tm!=='time'?'<th>Za</th>':''}
             <th>Zpo≈ædƒõn√≠</th><th>N√°st.</th>
           </tr></thead>
           <tbody>${deps.map((d,i)=>depRow(d,i,tm)).join('')}</tbody>
         </table>`}`;
}

function buildTabs(deps) {
  const t = {};
  deps.forEach(d => { const k = rtype(d.route?.type, d.route?.short_name); t[k] = (t[k]||0)+1; });
  return Object.entries(t).map(([k,c]) => `<button class="filter-tab" onclick="filterDeps('${k}',this)">${ricon(k)} ${k} (${c})</button>`).join('');
}

function depRow(dep, i, tm) {
  const route   = dep.route || {};
  const trip    = dep.trip  || {};
  const ts      = dep.departure_timestamp || dep.arrival_timestamp || {};
  const sn      = route.short_name || '?';
  const type    = rtype(route.type, sn);
  const cls     = rcls(type, sn);
  const display = ts.predicted || ts.scheduled;
  const tstr    = display ? new Date(display).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}) : '--:--';
  let mh = '';
  if (display) {
    const diff = Math.round((new Date(display) - Date.now()) / 60000);
    if      (diff <= 0) mh = `<span class="dtm now">NYN√ç</span>`;
    else if (diff <= 2) mh = `<span class="dtm soon">${diff}'</span>`;
    else if (diff <= 5) mh = `<span class="dtm near">${diff}'</span>`;
    else                mh = `<span class="dtm ok">${diff}'</span>`;
  }
  const dr = ts.delay ?? dep.delay;
  let dh = `<span class="dep-delay ot" style="opacity:.3">‚Äî</span>`;
  if (dr != null) {
    const dm = Math.round(dr/60);
    if (dm > 1) dh = `<span class="dep-delay late">+${dm} min</span>`;
    else if (dm < -1) dh = `<span class="dep-delay early">${dm} min</span>`;
    else dh = `<span class="dep-delay ot">¬±0</span>`;
  }
  const plat = dep.stop?.platform_code || '';
  const ac   = dep.vehicle_registration?.air_conditioned;
  const aci  = getSetting('showAC',true) && ac ? ' ‚ùÑÔ∏è' : '';
  return `<tr class="dep-row" data-type="${type.toLowerCase()}" style="animation-delay:${i*40}ms">
    <td><span class="route-badge ${cls}">${sn}</span></td>
    <td class="dep-headsign">${trip.headsign||dep.headsign||'‚Äî'}${aci}</td>
    <td><span class="dep-time">${tstr}</span></td>
    ${tm!=='time'?`<td>${mh}</td>`:''}
    <td>${dh}</td>
    <td class="dep-platform">${plat}</td>
  </tr>`;
}

function filterDeps(type, btn) {
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.dep-row').forEach(r => {
    r.style.display = (type==='all' || r.dataset.type===type.toLowerCase()) ? '' : 'none';
  });
}

function showLoading(name) {
  document.getElementById('boardContainer').innerHTML =
    `<div class="board-header"><div><div class="board-title">üìç ${name}</div><div class="board-sub">Naƒç√≠t√°m‚Ä¶</div></div></div>
     <div class="state-box"><div class="spinner"></div><div class="state-title">Kontaktuji Golemio API‚Ä¶</div></div>`;
}
function clearBoard() {
  document.getElementById('boardContainer').innerHTML = '';
}

// =====================
// ROUTE TYPE HELPERS
// =====================
function rtype(n, sn) {
  if (n===1||n===401)   return 'Metro';
  if (n===0||n===900)   return 'Tramvaj';
  if (n===2||n===100)   return 'Vlak';
  if (n===4)            return 'P≈ô√≠voz';
  const s = (sn||'').toString();
  if (['A','B','C'].includes(s)) return 'Metro';
  if (/^[PNX]\d/.test(s))       return 'Noƒçn√≠ bus';
  return 'Bus';
}
function rcls(type, sn) {
  if (type==='Metro') {
    const s=(sn||'').toUpperCase();
    if(s==='A') return 'rb-ma'; if(s==='B') return 'rb-mb'; if(s==='C') return 'rb-mc';
    return 'rb-mb';
  }
  if(type==='Tramvaj')   return 'rb-tram';
  if(type==='Vlak')      return 'rb-train';
  if(type==='P≈ô√≠voz')    return 'rb-ferry';
  if(type==='Noƒçn√≠ bus') return 'rb-night';
  return 'rb-bus';
}
function ricon(t) {
  return {Metro:'üöá',Tramvaj:'üöÉ',Vlak:'üöÇ',P≈ô√≠voz:'‚õ¥','Noƒçn√≠ bus':'üåô',Bus:'üöå'}[t]||'üöå';
}

// =====================
// AUTO REFRESH
// =====================
function startRf(id, name) {
  clearRf();
  if (rfInterval===0) return;
  rfCountdown = rfInterval;
  rfTimer = setInterval(() => {
    rfCountdown--;
    const rcd=document.getElementById('rcd'), rfill=document.getElementById('rfill');
    if(rcd) rcd.textContent=rfCountdown;
    if(rfill) rfill.style.width=(rfCountdown/rfInterval*100)+'%';
    if(rfCountdown<=0) loadDepartures(id,name);
  }, 1000);
}
function clearRf() { if(rfTimer){clearInterval(rfTimer);rfTimer=null;} }
function updateRefreshInterval() {
  rfInterval=parseInt(document.getElementById('refreshInterval').value);
  localStorage.setItem('pid_rf',rfInterval);
  if(curId) startRf(curId,curName);
}

// =====================
// VEHICLES ‚Äî /v2/vehiclepositions?limit=50
// =====================
async function loadVehicles() {
  if (!apiKey) { showErr('Zadejte API kl√≠ƒç.','vehicleError'); return; }
  hideErr('vehicleError');
  document.getElementById('vehicleContainer').innerHTML =
    '<div class="state-box"><div class="spinner"></div><div class="state-title">Naƒç√≠t√°m vozidla‚Ä¶</div></div>';
  try {
    const r = await goFetch(`${EP_VEHICLES}?limit=50`);
    if (!r.ok) { const e=await r.json().catch(()=>({})); throw new Error(`HTTP ${r.status}: ${e.message||''}`); }
    const d = await r.json();
    allVehicles = d.features || [];
    renderVehicles(allVehicles);
  } catch(e) {
    showErr(`Chyba vozidel: ${e.message}`,'vehicleError');
    document.getElementById('vehicleContainer').innerHTML =
      '<div class="state-box"><div class="state-icon">‚ö†Ô∏è</div><div class="state-title">Nepoda≈ôilo se naƒç√≠st</div></div>';
  }
}
function filterVehicles() {
  const q=document.getElementById('vehicleSearch').value.trim().toUpperCase();
  renderVehicles(q?allVehicles.filter(v=>(v.properties?.route?.short_name||'').toUpperCase().includes(q)):allVehicles);
}
function renderVehicles(veh) {
  if (!veh.length) {
    document.getElementById('vehicleContainer').innerHTML =
      '<div class="state-box"><div class="state-icon">üöå</div><div class="state-title">≈Ω√°dn√° vozidla</div></div>';
    return;
  }
  const cards = veh.map((v,i)=>{
    const p=v.properties||{}, route=p.route||{}, trip=p.trip||{};
    const sn=route.short_name||'?', type=rtype(route.type,sn), cls=rcls(type,sn);
    const delay=p.delay!=null?Math.round(p.delay/60):null;
    const dc=delay==null?'':delay>1?'late':delay<-1?'early':'ot';
    const dt=delay==null?'‚Äî':delay>0?`+${delay} min`:delay<0?`${delay} min`:'¬±0 min';
    const spd=p.speed!=null?Math.round(p.speed):null;
    const brg=p.bearing!=null?p.bearing:null;
    const ac=p.vehicle_registration?.air_conditioned;
    return `<div class="vehicle-card" style="animation-delay:${i*30}ms">
      <div class="vc-header">
        <div><span class="route-badge ${cls}">${ricon(type)} ${sn}</span>
        <div class="vc-heading" title="${trip.headsign||'‚Äî'}">${trip.headsign||'‚Äî'}</div></div>
        <div class="vc-dot"></div>
      </div>
      <div class="vc-meta">
        <div class="vc-mi"><div class="vc-ml">Zpo≈ædƒõn√≠</div><div class="vc-mv ${dc}">${dt}</div></div>
        <div class="vc-mi"><div class="vc-ml">Rychlost</div><div class="vc-mv">${spd!=null?spd+' km/h':'‚Äî'}</div></div>
        <div class="vc-mi"><div class="vc-ml">Smƒõr</div><div class="vc-mv">${brg!=null?brg+'¬∞':'‚Äî'}</div></div>
        <div class="vc-mi"><div class="vc-ml">Klima</div><div class="vc-mv">${ac?'‚ùÑÔ∏è Ano':ac===false?'‚úó Ne':'‚Äî'}</div></div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('vehicleContainer').innerHTML =
    `<div style="font-size:12px;font-family:var(--font-mono);color:var(--text3);margin-bottom:12px">${veh.length} vozidel ¬∑ ${new Date().toLocaleTimeString('cs-CZ')}</div>
     <div class="vehicle-grid">${cards}</div>`;
}

// =====================
// SAVED STOPS
// =====================
function toggleSave(id, name) {
  const idx = savedStops.findIndex(s=>s.id===id);
  if (idx>=0) savedStops.splice(idx,1); else savedStops.push({id,name});
  localStorage.setItem('pid_stops', JSON.stringify(savedStops));
  renderSaved();
  const btn=document.getElementById('savBtn');
  if(btn) btn.textContent=savedStops.some(s=>s.id===id)?'‚≠ê':'‚òÜ';
}
function renderSaved() {
  const el=document.getElementById('savedStopsList');
  if(!savedStops.length){el.innerHTML='<div class="empty-state">≈Ω√°dn√© ulo≈æen√© zast√°vky</div>';return;}
  el.innerHTML=savedStops.map(s=>`
    <div class="saved-stop ${curId===s.id?'active':''}" onclick="loadDepartures('${s.id}','${esc(s.name)}')">
      <div><div class="saved-stop-name">üöè ${s.name}</div><div class="saved-stop-id">${s.id}</div></div>
      <button class="saved-stop-remove" onclick="event.stopPropagation();removeSaved('${s.id}')" title="Odebrat">‚úï</button>
    </div>`).join('');
}
function removeSaved(id){savedStops=savedStops.filter(s=>s.id!==id);localStorage.setItem('pid_stops',JSON.stringify(savedStops));renderSaved();}
function clearSavedStops(){savedStops=[];localStorage.removeItem('pid_stops');renderSaved();}

// =====================
// SETTINGS
// =====================
function loadSettings() {
  const ri=document.getElementById('refreshInterval');
  const dl=document.getElementById('departureLimit');
  const td=document.getElementById('timeDisplay');
  if(ri) ri.value=getSetting('refreshInterval',30);
  if(dl) dl.value=getSetting('departureLimit',10);
  if(td) td.value=getSetting('timeDisplay','minutes');
  const sa=document.getElementById('togSkip');
  const ac=document.getElementById('togAC');
  if(sa) sa.className='toggle '+(getSetting('skipAtStop',true)?'on':'');
  if(ac) ac.className='toggle '+(getSetting('showAC',true)?'on':'');
}
function getSetting(k,d){return cfg[k]!=null?cfg[k]:d;}
function saveSetting(k,v){cfg[k]=v;localStorage.setItem('pid_cfg',JSON.stringify(cfg));}
function toggleSetting(k,el){const v=!el.classList.contains('on');el.className='toggle '+(v?'on':'');saveSetting(k,v);}

// =====================
// UTILS
// =====================
function goFetch(url) {
  return fetch(url, {headers:{'X-Access-Token':apiKey,'Content-Type':'application/json'}});
}
function showErr(msg,id){const el=document.getElementById(id);if(el){el.textContent=msg;el.style.display='block';}}
function hideErr(id){const el=document.getElementById(id);if(el)el.style.display='none';}
function esc(s){return(s||'').replace(/'/g,"\\'")}
</script>
</body>
</html>
